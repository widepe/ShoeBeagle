<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png"> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>ShoeBeagle - Deal Statistics Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f4ede3;
      padding: 20px;
      color: #2d2d2d;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    /* Store filter + results */
    .filter-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin: 10px 0 18px;
      flex-wrap: wrap;
    }

    .filter-row label {
      font-weight: 600;
      color: #214478ff;
    }

    .filter-row select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid #214478ff;
      background: #ffffff;
      font-size: 1rem;
      min-width: 260px;
    }

    .deals-panel {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .deals-panel h2 {
      color: #214478ff;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    .deals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }

    .deal-card {
      border: 2px solid #214478ff;
      border-radius: 12px;
      overflow: hidden;
      background: #d9e1ebff;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .deal-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(33, 68, 120, 0.3);
    }

    .deal-card img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: white;
      border-bottom: 2px solid #214478ff;
      padding: 10px;
    }

    .deal-card-body {
      padding: 12px 14px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .deal-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 8px;
      line-height: 1.3;
      color: #214478ff;
      min-height: 2.6em;
    }

    .deal-meta {
      font-size: 0.85rem;
      color: #49543a;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .deal-price-row {
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px solid rgba(33, 68, 120, 0.2);
    }

    .deal-price {
      font-weight: 800;
      color: #214478ff;
      font-size: 1.3rem;
    }

    .deal-orig {
      margin-left: 8px;
      color: #999;
      text-decoration: line-through;
      font-weight: 600;
      font-size: 1rem;
    }

    .deal-discount {
      display: inline-block;
      background: #dc3545;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: bold;
      margin-top: 6px;
    }

    /* Logo at top with 6px buffer */
    .brand-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 6px;
      margin-bottom: 8px;
    }
    .brand-logo {
      width: 520px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }

    h1 {
      color: #214478ff;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1rem;
    }

    .last-updated {
      text-align: center;
      color: #999;
      font-size: 0.9rem;
      margin-bottom: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-card h2 {
      color: #214478ff;
      font-size: 1.1rem;
      margin-bottom: 15px;
      border-bottom: 2px solid #214478ff;
      padding-bottom: 8px;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #214478ff;
      margin: 10px 0;
    }

    .stat-label { color: #666; font-size: 0.9rem; }

    .top-deal {
      background: rgba(33, 68, 120, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 4px solid #214478ff;
    }

    .top-deal-title {
      font-weight: bold;
      color: #214478ff;
      margin-bottom: 5px;
      font-size: 1.05rem;
    }

    .top-deal-store { color: #666; font-size: 0.85rem; margin-bottom: 8px; }
    .top-deal-price { font-size: 1.2rem; color: #2d2d2d; margin: 5px 0; }
    .top-deal-savings { color: #dc3545; font-weight: bold; font-size: 1.1rem; }

    .stores-table, .brand-table, .chart-container {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      overflow-x: auto;
    }

    .stores-table h2, .brand-table h2, .chart-container h2 {
      color: #214478ff;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    table { width: 100%; border-collapse: collapse; }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      vertical-align: top;
    }

    th {
      background: #214478ff;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    th:hover {
      background: #1a3661;
    }

    th.sortable::after {
      content: " ‚áÖ";
      opacity: 0.5;
      font-size: 0.9em;
    }

    th.sorted-asc::after {
      content: " ‚ñ≤";
      opacity: 1;
    }

    th.sorted-desc::after {
      content: " ‚ñº";
      opacity: 1;
    }

    tr:hover { background: rgba(33, 68, 120, 0.05); }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
      color: #666;
    }

    .error {
      background: #dc3545;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }

    .refresh-btn {
      display: inline-flex;
      margin: 0;
      padding: 12px 30px;
      background: #214478ff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
      text-align: center;
      justify-content: center;
      align-items: center;
    }

    /* Primary action: Refresh */
    .button-row .refresh-btn:first-child {
      background: #2e7d32;
    }

    .button-row .refresh-btn:first-child:hover {
      background: #256428;
    }
    
    .button-row .refresh-btn{
      min-width: 0;
      padding: 8px 14px;
      font-size: 0.92rem;
      margin: 0;
      border-radius: 8px;
      line-height: 1.1;
    }

    .button-row .refresh-btn {
      min-width: 140px;
      text-align: center;
    }

    .refresh-btn:hover { background: #1a3661; }

    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .bar-chart { margin-top: 20px; }
    .bar-row { margin-bottom: 12px; }

    .bar-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .bar-bg {
      background: #e0e0e0;
      height: 30px;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      background: linear-gradient(90deg, #214478ff, #3a6bb0);
      height: 100%;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 0.85rem;
    }

    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
      font-family: monospace;
      font-size: 0.85rem;
    }

    .debug-info h3 {
      color: #214478ff;
      margin-bottom: 10px;
      font-family: system-ui;
    }

    .note {
      font-size: 0.9rem;
      color: #666;
      margin-top: 6px;
    }

    /* Health Status Styles */
    .health-panel {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .health-panel h2 {
      color: #214478ff;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .health-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .health-card.healthy {
      border-color: #28a745;
      background: #f0f9f4;
    }

    .health-card.warning {
      border-color: #ffc107;
      background: #fffbf0;
    }

    .health-card.critical {
      border-color: #dc3545;
      background: #fff5f5;
    }

    .health-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .health-store-name {
      font-weight: bold;
      font-size: 1.1rem;
      color: #214478ff;
    }

    .health-status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .health-status-badge.healthy {
      background: #28a745;
      color: white;
    }

    .health-status-badge.warning {
      background: #ffc107;
      color: #333;
    }

    .health-status-badge.critical {
      background: #dc3545;
      color: white;
    }

    .health-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .health-metric {
      font-size: 0.9rem;
    }

    .health-metric-label {
      color: #666;
      font-size: 0.85rem;
    }

    .health-metric-value {
      font-weight: bold;
      color: #214478ff;
    }

    .health-issues {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }

    .health-issue {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .health-issue-icon {
      font-size: 1.1rem;
    }

    .health-issue.critical {
      color: #dc3545;
    }

    .health-issue.warning {
      color: #856404;
    }

    .health-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .health-summary-item {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
    }

    .health-summary-item.healthy {
      background: #28a745;
      color: white;
    }

    .health-summary-item.warning {
      background: #ffc107;
      color: #333;
    }

    .health-summary-item.critical {
      background: #dc3545;
      color: white;
    }

    .scraped-url {
      font-size: 0.8rem;
      color: #666;
      word-break: break-all;
      margin-top: 4px;
      font-family: monospace;
    }

    .scraped-url a {
      color: #214478ff;
      text-decoration: none;
    }

    .scraped-url a:hover {
      text-decoration: underline;
    }

    /* Data quality issue highlighting */
    .issue-count {
      font-weight: bold;
    }

    .issue-count.critical {
      color: #dc3545;
    }

    .issue-count.warning {
      color: #ff9800;
    }

    .issue-count.good {
      color: #28a745;
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="brand-header">
      <img class="brand-logo" src="/images/logo.svg" alt="Shoe Beagle">
    </div>

    <h1>Dashboard</h1>

    <div class="button-row">
      <button class="refresh-btn" onclick="loadStats()">Refresh Data</button>
      <button class="refresh-btn" onclick="openExternal('https://shoebeagle.com')">ShoeBeagle</button>
      <button class="refresh-btn" onclick="openExternal('https://github.com')">GitHub</button>
      <button class="refresh-btn" onclick="openExternal('https://vercel.com')">Vercel</button>
      <button class="refresh-btn" onclick="openExternal('https://apify.com')">Apify</button>
      <button class="refresh-btn" onclick="openExternal('https://www.firecrawl.dev')">Firecrawl</button>
      <button class="refresh-btn" onclick="openExternal('https://sendgrid.com')">SendGrid</button>
      <button class="refresh-btn" onclick="openExternal('https://namecheap.com')">Namecheap</button>
    </div>

    <div id="loading" class="loading">Loading deal statistics...</div>
    <div id="error" class="error" style="display: none;"></div>

    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info" style="display: none;">
      <h3>Debug Information:</h3>
      <div id="debugContent"></div>
    </div>

    <!-- Health Status Panel -->
    <div id="healthPanel" class="health-panel" style="display: none;">
      <h2>üè• Scraper Health Status</h2>
      <div class="health-summary" id="healthSummary"></div>
      <div class="health-grid" id="healthGrid"></div>
    </div>

    <!-- 30-Day Scraper Performance -->
    <div id="scraperHistoryPanel" class="health-panel" style="display: none;">
      <h2>üìà 30-Day Scraper Performance History</h2>
      <div id="scraperHistoryChart"></div>
    </div>

    <div id="content" style="display: none;">

      <!-- Key Metrics -->
      <div class="stats-grid">
        <div class="stat-card">
          <h2>Total Deals</h2>
          <div class="stat-value" id="totalDeals">-</div>
          <div class="stat-label">Across all stores</div>
        </div>

        <div class="stat-card">
          <h2>Active Stores</h2>
          <div class="stat-value" id="totalStores">-</div>
          <div class="stat-label">Providing deals</div>
        </div>

        <div class="stat-card">
          <h2>Unique Brands</h2>
          <div class="stat-value" id="totalBrands">-</div>
          <div class="stat-label">Different brands available</div>
        </div>

        <div class="stat-card">
          <h2>Average Discount</h2>
          <div class="stat-value" id="avgDiscount">-</div>
          <div class="stat-label">Across all discounted deals</div>
        </div>
      </div>

      <!-- Top Deals -->
      <div class="stats-grid">
        <div class="stat-card">
          <h2>Highest % Discount</h2>
          <div id="topPercentDeal" class="top-deal">Loading...</div>
        </div>

        <div class="stat-card">
          <h2>Biggest $ Savings</h2>
          <div id="topDollarDeal" class="top-deal">Loading...</div>
        </div>

        <div class="stat-card">
          <h2>Lowest Price</h2>
          <div id="lowestPriceDeal" class="top-deal">Loading...</div>
        </div>

        <div class="stat-card">
          <h2>Best Value</h2>
          <div id="bestValueDeal" class="top-deal">Loading...</div>
          <div class="stat-label" style="margin-top: 10px; font-style: italic;">
            Based on discount % + $ savings
          </div>
        </div>
      </div>

      <!-- Deals Browser by Store -->
      <div class="deals-panel">
        <h2>üîé Browse Deals by Store</h2>

        <div class="filter-row">
          <label for="storeSelect">Store:</label>
          <select id="storeSelect">
            <option value="__none__">Select store or Close</option>
          </select>
          <div id="storeCount" style="color:#666;font-size:0.95rem;"></div>
        </div>

        <div class="deals-grid" id="storeDealsGrid"></div>
      </div>

      <!-- Data Quality by Store -->
      <div class="stores-table">
        <h2>üìä Data Quality by Store</h2>
        <div class="note">Comprehensive data quality metrics for each store's scraped deals.</div>
        <table>
          <thead>
            <tr>
              <th class="sortable" onclick="sortDataQuality('store')">Store Name</th>
              <th class="sortable" onclick="sortDataQuality('totalDeals')">Total Deals</th>
              <th class="sortable" onclick="sortDataQuality('unknownBrands')">Unknown Brands</th>
              <th class="sortable" onclick="sortDataQuality('unknownModels')">Unknown Models</th>
              <th class="sortable" onclick="sortDataQuality('noPrice')">No Price</th>
              <th class="sortable" onclick="sortDataQuality('noSalePrice')">No Sale Price</th>
              <th class="sortable" onclick="sortDataQuality('badImage')">Bad/Missing Image</th>
              <th class="sortable" onclick="sortDataQuality('badUrl')">Bad/Missing URL</th>
            </tr>
          </thead>
          <tbody id="dataQualityTableBody"></tbody>
        </table>
      </div>

      <!-- Store Table -->
      <div class="stores-table">
        <h2>Store Breakdown</h2>
        <table>
          <thead>
            <tr>
              <th class="sortable" onclick="sortStoreTable('name')">Store Name</th>
              <th class="sortable" onclick="sortStoreTable('count')">Total Deals</th>
              <th class="sortable" onclick="sortStoreTable('avgDiscount')">Avg Discount %</th>
              <th class="sortable" onclick="sortStoreTable('avgSavings')">Avg $ Savings</th>
              <th>Best Deal</th>
            </tr>
          </thead>
          <tbody id="storesTableBody"></tbody>
        </table>
      </div>

      <!-- Brand Table -->
      <div class="brand-table">
        <h2>Top Brands (by deal count)</h2>
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Brand</th>
              <th>Total Deals</th>
              <th>Avg Discount %</th>
              <th>Price Range</th>
            </tr>
          </thead>
          <tbody id="brandsTableBody"></tbody>
        </table>
      </div>

      <!-- Price Distribution -->
      <div class="chart-container">
        <h2>Price Distribution</h2>
        <div class="bar-chart" id="priceChart"></div>
      </div>

    </div>
  </div>

  <script>
    // Store scraper URL mapping
    const SCRAPER_URLS = {
      'ASICS': 'https://www.asics.com/us/en-us/sale/mens-running-shoes/c/aa10107020/',
      'Brooks Running': 'https://www.brooksrunning.com/en_us/mens-sale-running-shoes/c/301/',
      'Holabird Sports': 'https://www.holabirdsports.com',
      'Fleet Feet': 'https://www.fleetfeet.com/collections/mens-running-shoes-on-sale',
      'Hoka': 'https://www.hoka.com/en/us/sale/mens-shoes/',
      'Janji': 'https://www.janji.com/collections/sale',
      'New Balance': 'https://www.newbalance.com/sale/mens-sale/',
      'On Running': 'https://www.on-running.com/en-us/shop/men/shoes/sale',
      'REI Co-op': 'https://www.rei.com/s/running-shoes',
      'Road Runner Sports': 'https://www.roadrunnersports.com/rrs/mens/shoes/sale/_/N-u5Z1z141i0',
      'Running Warehouse': 'https://www.runningwarehouse.com/',
      'Saucony': 'https://www.saucony.com/en/sale/',
      'Shoebacca': 'https://www.shoebacca.com/collections/clearance-athletic',
      'Sports Basement': 'https://shop.sportsbasement.com/collections/mens-running-shoes',
      'The Clymb': 'https://www.theclymb.com',
      'Zappos': 'https://www.zappos.com/men-athletic-shoes/CK_XARC81wHAAQLiAgMBAhg.zso',
    };

    let ALL_DEALS = [];
    let STORE_DATA = null;
    let CURRENT_STORE_SORT = { column: 'count', direction: 'desc' };
    let CURRENT_DATA_QUALITY_SORT = { column: 'totalDeals', direction: 'desc' };

    async function loadScraperHistory() {
      try {
        const cacheBuster = Date.now();
        const response = await fetch(`https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/scraper-data.json?t=${cacheBuster}`, {
          cache: "no-store"
        });
        
        if (!response.ok) {
          console.log("No scraper history available yet");
          return null;
        }
        
        return await response.json();
      } catch (err) {
        console.error("Error loading scraper history:", err);
        return null;
      }
    }

    function displayScraperHistory(scraperData) {
      const panel = document.getElementById('scraperHistoryPanel');
      const chart = document.getElementById('scraperHistoryChart');
      
      if (!panel || !chart || !scraperData || !scraperData.days || scraperData.days.length === 0) {
        return;
      }
      
      // Get all unique scraper names
      const allScrapers = new Set();
      scraperData.days.forEach(day => {
        day.scrapers.forEach(s => allScrapers.add(s.scraper));
      });
      
      const scraperNames = Array.from(allScrapers).sort();
      
      // Build table HTML
      let html = `
        <div style="overflow-x: auto;">
          <table style="font-size: 0.85rem;">
            <thead>
              <tr>
                <th style="min-width: 180px;">Scraper</th>
      `;
      
      // Add date headers
      scraperData.days.forEach(day => {
        const date = new Date(day.dayUTC);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        html += `<th style="min-width: 60px; font-size: 0.75rem;">${dateStr}</th>`;
      });
      
      html += `
              </tr>
            </thead>
            <tbody>
      `;
      
      // Add rows for each scraper
      scraperNames.forEach(scraperName => {
        html += `<tr><td><strong>${scraperName}</strong></td>`;
        
        scraperData.days.forEach(day => {
          const scraperEntry = day.scrapers.find(s => s.scraper === scraperName);
          
          if (!scraperEntry) {
            html += `<td style="text-align: center; color: #999;">‚Äî</td>`;
          } else if (!scraperEntry.ok) {
            html += `<td style="text-align: center; background: #fff5f5; color: #dc3545; font-weight: bold;">‚úó</td>`;
          } else {
            const count = scraperEntry.count || 0;
            const bgColor = count === 0 ? '#fff5f5' : count < 10 ? '#fffbf0' : '#f0f9f4';
            const textColor = count === 0 ? '#dc3545' : count < 10 ? '#856404' : '#28a745';
            html += `<td style="text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: bold;">${count}</td>`;
          }
        });
        
        html += `</tr>`;
      });
      
      html += `
            </tbody>
          </table>
        </div>
        <div style="margin-top: 15px; font-size: 0.85rem; color: #666;">
          <strong>Legend:</strong> 
          <span style="color: #28a745;">‚ñ†</span> Good (10+ deals) | 
          <span style="color: #856404;">‚ñ†</span> Warning (&lt;10 deals) | 
          <span style="color: #dc3545;">‚ñ†</span> Failed/Zero | 
          <span style="color: #999;">‚Äî</span> No data
        </div>
      `;
      
      chart.innerHTML = html;
      panel.style.display = 'block';
    }

    async function loadStats() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const content = document.getElementById('content');
      const debugInfo = document.getElementById('debugInfo');
      const debugContent = document.getElementById('debugContent');

      loading.style.display = 'block';
      error.style.display = 'none';
      content.style.display = 'none';
      debugInfo.style.display = 'none';

      try {
        const cacheBuster = Date.now();
        
        const [dealsResponse, mergeResponse] = await Promise.all([
          fetch(`https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/deals.json?t=${cacheBuster}`, {
            cache: "no-store"
          }),
          fetch(`/api/merge-deals?t=${cacheBuster}`, {
            cache: "no-store"
          }).catch(() => null)
        ]);
        
        const data = await dealsResponse.json();
        const mergeData = mergeResponse ? await mergeResponse.json() : null;

        if (!data.deals || !Array.isArray(data.deals)) {
          throw new Error('Invalid data format');
        }

        const deals = data.deals;
        ALL_DEALS = deals;
        buildStoreDropdown(deals);
        renderDealsForSelectedStore();
        
        const unknownBrands = deals.filter(d => (d.brand || '').trim() === 'Unknown' || !(d.brand || '').trim()).length;
        const uniqueBrands = [...new Set(deals.map(d => (d.brand || 'Unknown').trim()))]
          .filter(b => b && b !== 'Unknown')
          .sort();

        let debugHTML = `
          <strong>Total deals in array:</strong> ${deals.length}<br>
          <strong>Unknown brands:</strong> ${unknownBrands} (${deals.length ? ((unknownBrands / deals.length) * 100).toFixed(1) : '0.0'}%)<br>
          <strong>Deals by store (from JSON):</strong> ${JSON.stringify(data.dealsByStore)}<br>
          <strong>Unique stores found:</strong> ${[...new Set(deals.map(d => d.store))].join(', ')}<br>
          <strong>Shoe brands found (${uniqueBrands.length}):</strong> ${uniqueBrands.join(', ')}<br><br>
        `;

        if (mergeData && mergeData.storeMetadata) {
          debugHTML += `<strong>Scraper Blob URLs:</strong><br>`;
          Object.entries(mergeData.storeMetadata).forEach(([scraperName, meta]) => {
            if (meta.blobUrl) {
              debugHTML += `<div style="margin-left: 10px; margin-top: 4px;">
                <strong>${scraperName}:</strong> <a href="${meta.blobUrl}" target="_blank" style="color: #214478ff; word-break: break-all;">${meta.blobUrl}</a>
              </div>`;
            }
          });
          
          // Add daily deals blob URL
          debugHTML += `<div style="margin-left: 10px; margin-top: 4px;">
            <strong>Daily Deals (12):</strong> <a href="https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/twelve_daily_deals.json" target="_blank" style="color: #214478ff; word-break: break-all;">https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/twelve_daily_deals.json</a>
          </div>`;
        }

        debugContent.innerHTML = debugHTML;
        debugInfo.style.display = 'block';

        const stats = calculateStats(deals);
        STORE_DATA = stats.stores;
        displayStats(stats);
        displayDataQuality(deals);
        displayHealthStatus(deals, stats, mergeData);
        
        const scraperHistory = await loadScraperHistory();
        if (scraperHistory) {
          displayScraperHistory(scraperHistory);
        }

        loading.style.display = 'none';
        content.style.display = 'block';

      } catch (err) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = `Error loading data: ${err.message}`;
        console.error('Error:', err);
      }
    }

    function calculateStats(deals) {
      const stats = {
        totalDeals: deals.length,
        stores: {},
        brands: {},
        discounts: [],
        prices: [],
        unknownByStore: {}
      };

      deals.forEach(deal => {
        const salePrice = Number(deal.salePrice) || 0;
        const price = Number(deal.price) || 0;

        const store = (deal.store || 'Unknown').trim() || 'Unknown';
        const brandRaw = (deal.brand || '').trim();
        const brand = brandRaw ? brandRaw : 'Unknown';

        const dollarSavings = price > salePrice ? price - salePrice : 0;
        const percentOff = price > salePrice ? ((price - salePrice) / price) * 100 : 0;

        if (!stats.stores[store]) {
          stats.stores[store] = {
            count: 0,
            totalDiscount: 0,
            totalSavings: 0,
            deals: []
          };
        }
        stats.stores[store].count++;
        stats.stores[store].totalDiscount += percentOff;
        stats.stores[store].totalSavings += dollarSavings;
        stats.stores[store].deals.push(deal);

        if (!stats.unknownByStore[store]) {
          stats.unknownByStore[store] = { unknownCount: 0, total: 0 };
        }
        stats.unknownByStore[store].total++;
        if (brand === 'Unknown') stats.unknownByStore[store].unknownCount++;

        if (!stats.brands[brand]) {
          stats.brands[brand] = {
            count: 0,
            totalDiscount: 0,
            minPrice: salePrice || Infini
