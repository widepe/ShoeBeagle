// Snippet to add to your dashboard HTML - replace the displayHealthStatus function

async function loadStats() {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const content = document.getElementById('content');
  const debugInfo = document.getElementById('debugInfo');
  const debugContent = document.getElementById('debugContent');

  loading.style.display = 'block';
  error.style.display = 'none';
  content.style.display = 'none';
  debugInfo.style.display = 'none';

  try {
    const cacheBuster = Date.now();
    
    // CHANGED: Fetch both the deals blob AND the merge endpoint metadata
    const [dealsResponse, mergeResponse] = await Promise.all([
      fetch(`https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/deals.json?t=${cacheBuster}`, {
        cache: "no-store"
      }),
      fetch(`/api/merge-deals?t=${cacheBuster}`, {
        cache: "no-store"
      }).catch(() => null) // Don't fail if merge endpoint is slow/unavailable
    ]);
    
    const data = await dealsResponse.json();
    const mergeData = mergeResponse ? await mergeResponse.json() : null;

    if (!data.deals || !Array.isArray(data.deals)) {
      throw new Error('Invalid data format');
    }

    const deals = data.deals;
    ALL_DEALS = deals;
    buildStoreDropdown(deals);
    renderDealsForSelectedStore();
    
    // Debug summary
    const unknownBrands = deals.filter(d => (d.brand || '').trim() === 'Unknown' || !(d.brand || '').trim()).length;
    const uniqueBrands = [...new Set(deals.map(d => (d.brand || 'Unknown').trim()))]
      .filter(b => b && b !== 'Unknown')
      .sort();

    const debugHTML = `
      <strong>Total deals in array:</strong> ${deals.length}<br>
      <strong>Unknown brands:</strong> ${unknownBrands} (${deals.length ? ((unknownBrands / deals.length) * 100).toFixed(1) : '0.0'}%)<br>
      <strong>Deals by store (from JSON):</strong> ${JSON.stringify(data.dealsByStore)}<br>
      <strong>Unique stores found:</strong> ${[...new Set(deals.map(d => d.store))].join(', ')}<br>
      <strong>Shoe brands found (${uniqueBrands.length}):</strong> ${uniqueBrands.join(', ')}
    `;
    debugContent.innerHTML = debugHTML;
    debugInfo.style.display = 'block';

    document.getElementById('lastUpdated').textContent =
      `Last updated: ${new Date(data.lastUpdated || Date.now()).toLocaleString()}`;

    const stats = calculateStats(deals);
    displayStats(stats);
    displayHealthStatus(deals, stats, mergeData); // CHANGED: Pass mergeData

    loading.style.display = 'none';
    content.style.display = 'block';

  } catch (err) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = `Error loading data: ${err.message}`;
    console.error('Error:', err);
  }
}

function displayHealthStatus(deals, stats, mergeData) {
  const healthPanel = document.getElementById('healthPanel');
  const healthGrid = document.getElementById('healthGrid');
  const healthSummary = document.getElementById('healthSummary');

  if (!healthPanel || !healthGrid || !healthSummary) return;

  const storeMetadata = mergeData?.storeMetadata || {};
  const storeHealth = {};
  let healthyCount = 0;
  let warningCount = 0;
  let criticalCount = 0;

  // Analyze each store
  Object.entries(stats.stores).forEach(([storeName, storeData]) => {
    const health = {
      store: storeName,
      dealCount: storeData.count,
      issues: [],
      status: 'healthy',
      metadata: storeMetadata[storeName] || null // NEW: Get metadata
    };

    // Get deals for this store
    const storeDeals = deals.filter(d => (d.store || 'Unknown').trim() === storeName);

    // Check for zero results - CRITICAL
    if (storeData.count === 0) {
      health.issues.push({ type: 'critical', message: 'ðŸš¨ ZERO RESULTS - Scraper may be broken' });
      health.status = 'critical';
    }

    // Check for unknown brands
    const unknownBrands = storeDeals.filter(d => 
      (d.brand || '').trim() === 'Unknown' || !(d.brand || '').trim()
    ).length;
    const unknownPercent = storeData.count > 0 ? (unknownBrands / storeData.count) * 100 : 0;
    
    if (unknownPercent > 50) {
      health.issues.push({ type: 'critical', message: `ðŸš¨ ${unknownPercent.toFixed(0)}% Unknown Brands` });
      health.status = 'critical';
    } else if (unknownPercent > 20) {
      health.issues.push({ type: 'warning', message: `âš ï¸ ${unknownPercent.toFixed(0)}% Unknown Brands` });
      if (health.status !== 'critical') health.status = 'warning';
    }

    // Check for missing images
    const missingImages = storeDeals.filter(d => !d.image || d.image.includes('placehold.co')).length;
    const missingImagesPercent = storeData.count > 0 ? (missingImages / storeData.count) * 100 : 0;
    
    if (missingImagesPercent > 30) {
      health.issues.push({ type: 'warning', message: `âš ï¸ ${missingImagesPercent.toFixed(0)}% Missing Images` });
      if (health.status !== 'critical') health.status = 'warning';
    }

    // Check for missing URLs
    const missingUrls = storeDeals.filter(d => !d.url || d.url === '#').length;
    const missingUrlsPercent = storeData.count > 0 ? (missingUrls / storeData.count) * 100 : 0;
    
    if (missingUrlsPercent > 10) {
      health.issues.push({ type: 'warning', message: `âš ï¸ ${missingUrlsPercent.toFixed(0)}% Missing URLs` });
      if (health.status !== 'critical') health.status = 'warning';
    }

    // Check for missing prices
    const missingPrices = storeDeals.filter(d => !d.price || Number(d.price) === 0).length;
    if (missingPrices > 0) {
      health.issues.push({ type: 'warning', message: `âš ï¸ ${missingPrices} Missing Prices` });
      if (health.status !== 'critical') health.status = 'warning';
    }

    // Check for missing models
    const missingModels = storeDeals.filter(d => !d.model || d.model.trim() === '').length;
    const missingModelsPercent = storeData.count > 0 ? (missingModels / storeData.count) * 100 : 0;
    
    if (missingModelsPercent > 30) {
      health.issues.push({ type: 'warning', message: `âš ï¸ ${missingModelsPercent.toFixed(0)}% Missing Models` });
      if (health.status !== 'critical') health.status = 'warning';
    }

    // Low deal count warning (potential issue)
    if (storeData.count > 0 && storeData.count < 5) {
      health.issues.push({ type: 'warning', message: `âš ï¸ Low Deal Count (${storeData.count})` });
      if (health.status !== 'critical') health.status = 'warning';
    }

    storeHealth[storeName] = health;

    // Count statuses
    if (health.status === 'healthy') healthyCount++;
    else if (health.status === 'warning') warningCount++;
    else if (health.status === 'critical') criticalCount++;
  });

  // Display summary
  healthSummary.innerHTML = `
    <div class="health-summary-item healthy">${healthyCount} Healthy</div>
    <div class="health-summary-item warning">${warningCount} Warnings</div>
    <div class="health-summary-item critical">${criticalCount} Critical</div>
  `;

  // Sort stores: critical first, then warning, then healthy
  const sortedStores = Object.values(storeHealth).sort((a, b) => {
    const statusOrder = { critical: 0, warning: 1, healthy: 2 };
    return statusOrder[a.status] - statusOrder[b.status];
  });

  // Display health cards with metadata
  healthGrid.innerHTML = sortedStores.map(health => {
    const meta = health.metadata;
    const hasMetadata = meta && !meta.error;
    
    // Format timestamp
    let timestampStr = 'â€”';
    if (hasMetadata && meta.timestamp) {
      const date = new Date(meta.timestamp);
      timestampStr = date.toLocaleString();
    }
    
    return `
      <div class="health-card ${health.status}">
        <div class="health-header">
          <div class="health-store-name">${health.store}</div>
          <div class="health-status-badge ${health.status}">
            ${health.status === 'healthy' ? 'âœ“ Healthy' : health.status === 'warning' ? 'âš  Warning' : 'âœ— Critical'}
          </div>
        </div>
        
        <div class="health-metrics">
          <div class="health-metric">
            <div class="health-metric-label">Total Deals</div>
            <div class="health-metric-value">${health.dealCount.toLocaleString()}</div>
          </div>
          ${hasMetadata && meta.duration ? `
            <div class="health-metric">
              <div class="health-metric-label">Scrape Time</div>
              <div class="health-metric-value">${meta.duration}</div>
            </div>
          ` : ''}
        </div>

        ${hasMetadata ? `
          <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
            <div style="margin-bottom: 4px;">
              <strong>Last Scraped:</strong> ${timestampStr}
            </div>
            ${meta.blobUrl ? `
              <div style="word-break: break-all;">
                <strong>Blob:</strong> <a href="${meta.blobUrl}" target="_blank" style="color: #214478ff;">${meta.blobUrl.substring(0, 50)}...</a>
              </div>
            ` : ''}
          </div>
        ` : ''}

        ${health.issues.length > 0 ? `
          <div class="health-issues">
            ${health.issues.map(issue => `
              <div class="health-issue ${issue.type}">
                <span>${issue.message}</span>
              </div>
            `).join('')}
          </div>
        ` : '<div style="margin-top: 10px; color: #28a745; font-weight: bold;">âœ“ All checks passed</div>'}
      </div>
    `;
  }).join('');

  healthPanel.style.display = 'block';
}
