<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>ShoeBeagle - Deal Statistics Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f4ede3;
      padding: 20px;
      color: #2d2d2d;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    /* Store filter + results */
    .filter-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin: 10px 0 18px;
      flex-wrap: wrap;
    }

    .filter-row label {
      font-weight: 600;
      color: #214478ff;
    }

    .filter-row select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid #214478ff;
      background: #ffffff;
      font-size: 1rem;
      min-width: 260px;
    }

    .deals-panel {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .deals-panel h2 {
      color: #214478ff;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    .deals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }

    .deal-card {
      border: 2px solid #214478ff;
      border-radius: 12px;
      overflow: hidden;
      background: #d9e1ebff;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .deal-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(33, 68, 120, 0.3);
    }

    .deal-card img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: white;
      border-bottom: 2px solid #214478ff;
      padding: 10px;
    }

    .deal-card-body {
      padding: 12px 14px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .deal-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 8px;
      line-height: 1.3;
      color: #214478ff;
      min-height: 2.6em;
    }

    .deal-meta {
      font-size: 0.85rem;
      color: #49543a;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .deal-price-row {
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px solid rgba(33, 68, 120, 0.2);
    }

    .deal-price {
      font-weight: 800;
      color: #214478ff;
      font-size: 1.3rem;
    }

    .deal-orig {
      margin-left: 8px;
      color: #999;
      text-decoration: line-through;
      font-weight: 600;
      font-size: 1rem;
    }

    .deal-discount {
      display: inline-block;
      background: #dc3545;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: bold;
      margin-top: 6px;
    }

    /* Logo at top with 6px buffer */
    .brand-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 6px;
      margin-bottom: 8px;
    }
    .brand-logo {
      width: 520px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }

    h1 {
      color: #214478ff;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }

    .meta-line {
      text-align: center;
      color: #777;
      margin-bottom: 22px;
      font-size: 0.95rem;
    }

    .stores-table, .chart-container {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      overflow-x: auto;
    }

    .stores-table h2, .chart-container h2 {
      color: #214478ff;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    table { width: 100%; border-collapse: collapse; }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      vertical-align: top;
    }

    th {
      background: #214478ff;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    th:hover { background: #1a3661; }

    th.sortable::after {
      content: " ‚áÖ";
      opacity: 0.5;
      font-size: 0.9em;
    }

    th.sorted-asc::after { content: " ‚ñ≤"; opacity: 1; }
    th.sorted-desc::after { content: " ‚ñº"; opacity: 1; }

    tr:hover { background: rgba(33, 68, 120, 0.05); }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
      color: #666;
    }

    .error {
      background: #dc3545;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }

    .refresh-btn {
      display: inline-flex;
      margin: 0;
      padding: 12px 30px;
      background: #214478ff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
      text-align: center;
      justify-content: center;
      align-items: center;
    }

    /* Primary action: Refresh */
    .button-row .refresh-btn:first-child {
      background: #2e7d32;
    }
    .button-row .refresh-btn:first-child:hover {
      background: #256428;
    }

    .button-row .refresh-btn{
      min-width: 0;
      padding: 8px 14px;
      font-size: 0.92rem;
      margin: 0;
      border-radius: 8px;
      line-height: 1.1;
    }

    .button-row .refresh-btn { min-width: 140px; text-align: center; }
    .refresh-btn:hover { background: #1a3661; }

    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }

    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
      font-family: monospace;
      font-size: 0.85rem;
    }

    .debug-info h3 {
      color: #214478ff;
      margin-bottom: 10px;
      font-family: system-ui;
    }

    .note {
      font-size: 0.9rem;
      color: #666;
      margin-top: 6px;
    }

    /* Health Status Styles */
    .health-panel {
      background: white;
      border: 2px solid #214478ff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .health-panel h2 {
      color: #214478ff;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 15px;
    }

    .health-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
    }

    .health-card.healthy { border-color: #28a745; background: #f0f9f4; }
    .health-card.warning { border-color: #ffc107; background: #fffbf0; }
    .health-card.critical { border-color: #dc3545; background: #fff5f5; }

    .health-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .health-store-name {
      font-weight: bold;
      font-size: 1.1rem;
      color: #214478ff;
    }

    .health-status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .health-status-badge.healthy { background: #28a745; color: white; }
    .health-status-badge.warning { background: #ffc107; color: #333; }
    .health-status-badge.critical { background: #dc3545; color: white; }

    .health-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .health-metric { font-size: 0.9rem; }
    .health-metric-label { color: #666; font-size: 0.85rem; margin-bottom: 3px; }
    .health-metric-value { font-weight: bold; color: #214478ff; word-break: break-word; }
    .health-metric-value.na { color: #999; font-style: italic; }

    .health-metric.full {
      grid-column: 1 / -1;
    }

    .inline-pair {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: baseline;
    }

    .inline-pill {
      background: rgba(33, 68, 120, 0.06);
      border: 1px solid rgba(33, 68, 120, 0.18);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.82rem;
      color: #214478ff;
      font-weight: 700;
    }

    .health-issues {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }

    .health-issue {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .health-issue.critical { color: #dc3545; }
    .health-issue.warning { color: #856404; }

    .health-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .health-summary-item {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
    }

    .health-summary-item.healthy { background: #28a745; color: white; }
    .health-summary-item.warning { background: #ffc107; color: #333; }
    .health-summary-item.critical { background: #dc3545; color: white; }

    .scraped-url {
      font-size: 0.75rem;
      color: #666;
      word-break: break-all;
      margin-top: 6px;
      font-family: monospace;
      line-height: 1.3;
    }

    .scraped-url a {
      color: #214478ff;
      text-decoration: none;
    }
    .scraped-url a:hover { text-decoration: underline; }

    /* Total Deals + Gender breakdown styles */
    .gender-breakdown {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(33, 68, 120, 0.2);
    }

    .gender-breakdown-title {
      font-size: 0.9rem;
      color: #214478ff;
      margin-bottom: 8px;
      font-weight: 800;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }

    .gender-breakdown-subtitle {
      font-size: 0.8rem;
      color: #666;
      font-weight: 600;
    }

    .gender-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      font-size: 0.85rem;
    }

    .gender-stat {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      background: rgba(33, 68, 120, 0.05);
      border-radius: 4px;
    }

    .gender-stat-label { color: #666; }
    .gender-stat-value { font-weight: bold; color: #214478ff; }

    /* Data quality issue highlighting */
    .issue-count { font-weight: bold; }
    .issue-count.critical { color: #dc3545; }
    .issue-count.warning { color: #ff9800; }
    .issue-count.good { color: #28a745; }

    /* 30-day history table styles */
    .history-table { font-size: 0.85rem; margin-top: 15px; }

    .history-table th {
      min-width: 50px;
      font-size: 0.75rem;
      padding: 8px 6px;
    }

    .history-table td {
      text-align: center;
      padding: 8px 6px;
      font-weight: bold;
    }

    .history-table .scraper-name {
      text-align: left;
      font-weight: bold;
      min-width: 180px;
      padding-left: 12px;
    }

    .history-cell-success { background: #f0f9f4; color: #28a745; }
    .history-cell-warning { background: #fffbf0; color: #856404; }
    .history-cell-failed  { background: #fff5f5; color: #dc3545; }
    .history-cell-missing { color: #999; }

    .history-legend {
      margin-top: 15px;
      font-size: 0.85rem;
      color: #666;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .history-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="brand-header">
      <img class="brand-logo" src="/images/logo.svg" alt="Shoe Beagle">
    </div>

    <h1>Dashboard</h1>
    <div id="overallMeta" class="meta-line" style="display:none;"></div>

    <div class="button-row">
      <button class="refresh-btn" onclick="loadStats()">Refresh Data</button>
      <button class="refresh-btn" onclick="openExternal('https://shoebeagle.com')">ShoeBeagle</button>
      <button class="refresh-btn" onclick="openExternal('https://github.com')">GitHub</button>
      <button class="refresh-btn" onclick="openExternal('https://vercel.com')">Vercel</button>
      <button class="refresh-btn" onclick="openExternal('https://apify.com')">Apify</button>
      <button class="refresh-btn" onclick="openExternal('https://www.firecrawl.dev')">Firecrawl</button>
      <button class="refresh-btn" onclick="openExternal('https://sendgrid.com')">SendGrid</button>
      <button class="refresh-btn" onclick="openExternal('https://namecheap.com')">Namecheap</button>
    </div>

    <div id="loading" class="loading">Loading deal statistics...</div>
    <div id="error" class="error" style="display: none;"></div>

    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info" style="display: none;">
      <h3>Debug Information:</h3>
      <div id="debugContent"></div>
    </div>

    <!-- Health Status Panel -->
    <div id="healthPanel" class="health-panel" style="display: none;">
      <h2>üè• Scraper Health Status</h2>
      <div class="health-summary" id="healthSummary"></div>
      <div class="health-grid" id="healthGrid"></div>
    </div>

    <!-- 30-Day Scraper Performance -->
    <div id="scraperHistoryPanel" class="health-panel" style="display: none;">
      <h2>üìà 30-Day Scraper Performance History</h2>
      <div id="scraperHistoryChart"></div>
    </div>

    <div id="content" style="display: none;">

      <!-- Deals Browser by Store -->
      <div class="deals-panel">
        <h2>üîé Browse Deals by Store</h2>

        <div class="filter-row">
          <label for="storeSelect">Store:</label>
          <select id="storeSelect">
            <option value="__none__">Select store or Close</option>
          </select>
          <div id="storeCount" style="color:#666;font-size:0.95rem;"></div>
        </div>

        <div class="deals-grid" id="storeDealsGrid"></div>
      </div>

      <!-- Data Quality by Store -->
      <div class="stores-table">
        <h2>üìä Data Quality by Store</h2>
        <div class="note">Comprehensive data quality metrics for each store's scraped deals.</div>
        <table>
          <thead>
            <tr>
              <th class="sortable" onclick="sortDataQuality('store')">Store Name</th>
              <th class="sortable" onclick="sortDataQuality('totalDeals')">Total Deals</th>
              <th class="sortable" onclick="sortDataQuality('unknownBrands')">Unknown Brands</th>
              <th class="sortable" onclick="sortDataQuality('unknownModels')">Unknown Models</th>
              <th class="sortable" onclick="sortDataQuality('noPrice')">No Price</th>
              <th class="sortable" onclick="sortDataQuality('noSalePrice')">No Sale Price</th>
              <th class="sortable" onclick="sortDataQuality('badImage')">Bad/Missing Image</th>
              <th class="sortable" onclick="sortDataQuality('badUrl')">Bad/Missing URL</th>
            </tr>
          </thead>
          <tbody id="dataQualityTableBody"></tbody>
        </table>
      </div>

      <!-- Store Table -->
      <div class="stores-table">
        <h2>Store Breakdown</h2>
        <table>
          <thead>
            <tr>
              <th class="sortable" onclick="sortStoreTable('name')">Store Name</th>
              <th class="sortable" onclick="sortStoreTable('count')">Total Deals</th>
              <th class="sortable" onclick="sortStoreTable('avgDiscount')">Avg Discount %</th>
              <th class="sortable" onclick="sortStoreTable('avgSavings')">Avg $ Savings</th>
              <th>Best Deal</th>
            </tr>
          </thead>
          <tbody id="storesTableBody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <script>
    // Store scraper URL mapping (canonical store list)
    const SCRAPER_URLS = {
      'Als': 'https://www.als.com/',
      'ASICS': 'https://www.asics.com/us/en-us/sale/mens-running-shoes/c/aa10107020/',
      'Brooks Running': 'https://www.brooksrunning.com/en_us/mens-sale-running-shoes/c/301/',
      'Fleet Feet': 'https://www.fleetfeet.com/collections/mens-running-shoes-on-sale',
      'Holabird Sports': 'https://www.holabirdsports.com',
      'REI': 'https://www.rei.com/',
      'Road Runner Sports': 'https://www.roadrunnersports.com/rrs/mens/shoes/sale/_/N-u5Z1z141i0',
      'Running Warehouse': 'https://www.runningwarehouse.com/',
      'Shoebacca': 'https://www.shoebacca.com/collections/clearance-athletic',
      'Snails Pace': 'https://www.asnailspace.com/',
      'Zappos': 'https://www.zappos.com/men-athletic-shoes/CK_XARC81wHAAQLiAgMBAhg.zso',
    };

    const CANONICAL_STORES = Object.keys(SCRAPER_URLS).slice().sort((a,b) => a.localeCompare(b));

    let ALL_DEALS = [];
    let STORE_DATA = null;
    let CURRENT_STORE_SORT = { column: 'count', direction: 'desc' };
    let CURRENT_DATA_QUALITY_SORT = { column: 'totalDeals', direction: 'desc' };

    async function loadScraperHistory() {
      try {
        const cacheBuster = Date.now();
        const response = await fetch(`https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/scraper-data.json?t=${cacheBuster}`, {
          cache: "no-store"
        });

        if (!response.ok) {
          console.log("No scraper history available yet");
          return null;
        }

        return await response.json();
      } catch (err) {
        console.error("Error loading scraper history:", err);
        return null;
      }
    }

    function displayScraperHistory(scraperData) {
      const panel = document.getElementById('scraperHistoryPanel');
      const chart = document.getElementById('scraperHistoryChart');

      if (!panel || !chart || !scraperData || !scraperData.days || scraperData.days.length === 0) {
        return;
      }

      // Get all unique scraper names
      const allScrapers = new Set();
      scraperData.days.forEach(day => {
        (day.scrapers || []).forEach(s => allScrapers.add(s.scraper));
      });

      const scraperNames = Array.from(allScrapers).sort();

      // Build 30 dates newest -> oldest (today on the far left)
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const allDates = [];
      for (let i = 0; i < 30; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        allDates.push(d.toISOString().split('T')[0]);
      }

      // Create a map of existing data
      const dataMap = {};
      scraperData.days.forEach(day => {
        const dateKey = (day.dayUTC || '').split('T')[0];
        if (dateKey) dataMap[dateKey] = day;
      });

      let html = `
        <div style="overflow-x: auto;">
          <table class="history-table">
            <thead>
              <tr>
                <th class="scraper-name">Scraper</th>
      `;

      // Date headers newest -> oldest
      allDates.forEach(dateStr => {
        const date = new Date(dateStr + 'T00:00:00');
        const monthDay = `${date.getMonth() + 1}/${date.getDate()}`;
        html += `<th>${monthDay}</th>`;
      });

      html += `
              </tr>
            </thead>
            <tbody>
      `;

      scraperNames.forEach(scraperName => {
        html += `<tr><td class="scraper-name">${scraperName}</td>`;

        allDates.forEach(dateStr => {
          const dayData = dataMap[dateStr];

          if (!dayData) {
            html += `<td class="history-cell-failed">‚úó</td>`;
          } else {
            const scraperEntry = (dayData.scrapers || []).find(s => s.scraper === scraperName);

            if (!scraperEntry) {
              html += `<td class="history-cell-failed">‚úó</td>`;
            } else if (!scraperEntry.ok) {
              html += `<td class="history-cell-failed">‚úó</td>`;
            } else {
              const count = scraperEntry.count || 0;
              if (count === 0) html += `<td class="history-cell-failed">0</td>`;
              else if (count < 10) html += `<td class="history-cell-warning">${count}</td>`;
              else html += `<td class="history-cell-success">${count}</td>`;
            }
          }
        });

        html += `</tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
        <div class="history-legend">
          <div class="history-legend-item">
            <span style="color: #28a745; font-weight: bold;">‚ñ†</span> Good (10+ deals)
          </div>
          <div class="history-legend-item">
            <span style="color: #856404; font-weight: bold;">‚ñ†</span> Warning (&lt;10 deals)
          </div>
          <div class="history-legend-item">
            <span style="color: #dc3545; font-weight: bold;">‚úó</span> Failed/Zero/Not Run
          </div>
        </div>
      `;

      chart.innerHTML = html;
      panel.style.display = 'block';
    }

    function calculateGenderStats(deals) {
      const stats = { mens: 0, womens: 0, unisex: 0, unknown: 0 };

      deals.forEach(deal => {
        const gender = (deal.gender || '').toLowerCase().trim();

        if (gender === 'mens' || gender === 'men' || gender === 'male' || gender === "men's") stats.mens++;
        else if (gender === 'womens' || gender === 'women' || gender === 'female' || gender === "women's") stats.womens++;
        else if (gender === 'unisex') stats.unisex++;
        else stats.unknown++;
      });

      return stats;
    }

    async function loadStats() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const content = document.getElementById('content');
      const debugInfo = document.getElementById('debugInfo');
      const debugContent = document.getElementById('debugContent');

      loading.style.display = 'block';
      error.style.display = 'none';
      content.style.display = 'none';
      debugInfo.style.display = 'none';

      try {
        const cacheBuster = Date.now();

        // Fetch deals.json (required)
        const dealsResponse = await fetch(`https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/deals.json?t=${cacheBuster}`, {
          cache: "no-store"
        });

        if (!dealsResponse.ok) throw new Error(`Failed to fetch deals: ${dealsResponse.status}`);

        const data = await dealsResponse.json();

        // Try to fetch merge-deals metadata (optional, with timeout)
        let mergeData = null;
        try {
          const mergeController = new AbortController();
          const mergeTimeout = setTimeout(() => mergeController.abort(), 5000);

          const mergeResponse = await fetch(`/api/merge-deals?t=${cacheBuster}`, {
            cache: "no-store",
            signal: mergeController.signal
          });

          clearTimeout(mergeTimeout);

          if (mergeResponse.ok) mergeData = await mergeResponse.json();
        } catch (mergeError) {
          console.log("Could not load merge metadata (continuing without it):", mergeError.message);
        }

        if (!data.deals || !Array.isArray(data.deals)) throw new Error('Invalid data format');

        const deals = data.deals;
        ALL_DEALS = deals;

        buildStoreDropdown(deals);
        renderDealsForSelectedStore();

        // Debug
        const unknownBrands = deals.filter(d => (d.brand || '').trim() === 'Unknown' || !(d.brand || '').trim()).length;
        const uniqueBrands = [...new Set(deals.map(d => (d.brand || 'Unknown').trim()))]
          .filter(b => b && b !== 'Unknown')
          .sort();

        let debugHTML = `
          <strong>Total deals in array:</strong> ${deals.length}<br>
          <strong>Unknown brands:</strong> ${unknownBrands} (${deals.length ? ((unknownBrands / deals.length) * 100).toFixed(1) : '0.0'}%)<br>
          <strong>Deals by store (from JSON):</strong> ${JSON.stringify(data.dealsByStore)}<br>
          <strong>Unique stores found:</strong> ${[...new Set(deals.map(d => d.store))].filter(Boolean).join(', ')}<br>
          <strong>Shoe brands found (${uniqueBrands.length}):</strong> ${uniqueBrands.join(', ')}<br><br>
        `;

        if (mergeData && mergeData.storeMetadata) {
          debugHTML += `<strong>Scraper Blob URLs:</strong><br>`;
          Object.entries(mergeData.storeMetadata).forEach(([scraperName, meta]) => {
            if (meta.blobUrl) {
              debugHTML += `<div style="margin-left: 10px; margin-top: 4px;">
                <strong>${scraperName}:</strong> <a href="${meta.blobUrl}" target="_blank" style="color: #214478ff; word-break: break-all;">${meta.blobUrl}</a>
              </div>`;
            }
          });

          debugHTML += `<div style="margin-left: 10px; margin-top: 4px;">
            <strong>Daily Deals (12):</strong> <a href="https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/twelve_daily_deals.json" target="_blank" style="color: #214478ff; word-break: break-all;">https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com/twelve_daily_deals.json</a>
          </div>`;
        }

        debugContent.innerHTML = debugHTML;
        debugInfo.style.display = 'block';

        const stats = calculateStats(deals);
        STORE_DATA = stats.stores;

        // Overall meta line
        displayOverallMeta(stats, data, mergeData);

        displayDataQuality(deals, stats);
        displayHealthStatus(deals, stats, mergeData);

        const scraperHistory = await loadScraperHistory();
        if (scraperHistory) displayScraperHistory(scraperHistory);

        loading.style.display = 'none';
        content.style.display = 'block';

      } catch (err) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = `Error loading data: ${err.message}`;
        console.error('Error:', err);
      }
    }

    function displayOverallMeta(stats, dealsJson, mergeData) {
      const el = document.getElementById('overallMeta');
      if (!el) return;

      // Prefer deals.json lastUpdated if present, else merge-deals timestamp if present
      let lastUpdated = dealsJson?.lastUpdated || mergeData?.timestamp || mergeData?.lastUpdated || null;

      let lastUpdatedStr = 'Not Available';
      if (lastUpdated) {
        const d = new Date(lastUpdated);
        lastUpdatedStr = Number.isFinite(d.getTime()) ? d.toLocaleString() : String(lastUpdated);
      }

      el.innerHTML = `
        <span class="inline-pill">Total Deals: ${stats.totalDeals.toLocaleString()}</span>
        <span class="inline-pill">Last Updated: ${lastUpdatedStr}</span>
      `;
      el.style.display = 'block';
    }

    function calculateStats(deals) {
      const stats = {
        totalDeals: deals.length,
        stores: {},
        discounts: [],
        prices: []
      };

      deals.forEach(deal => {
        const salePrice = Number(deal.salePrice) || 0;
        const price = Number(deal.price) || 0;

        const store = (deal.store || 'Unknown').trim() || 'Unknown';

        const dollarSavings = price > salePrice ? price - salePrice : 0;
        const percentOff = price > salePrice ? ((price - salePrice) / price) * 100 : 0;

        if (!stats.stores[store]) {
          stats.stores[store] = { count: 0, totalDiscount: 0, totalSavings: 0, deals: [] };
        }
        stats.stores[store].count++;
        stats.stores[store].totalDiscount += percentOff;
        stats.stores[store].totalSavings += dollarSavings;
        stats.stores[store].deals.push(deal);

        if (percentOff > 0) {
          stats.discounts.push({ deal, percentOff, dollarSavings, salePrice });
        }

        if (salePrice > 0) stats.prices.push(salePrice);
      });

      // Ensure ALL stores always have a report (even if 0)
      CANONICAL_STORES.forEach(store => {
        if (!stats.stores[store]) {
          stats.stores[store] = { count: 0, totalDiscount: 0, totalSavings: 0, deals: [] };
        }
      });

      // If Unknown exists, keep it too (optional)
      if (stats.stores['Unknown'] && !CANONICAL_STORES.includes('Unknown')) {
        // keep as-is
      }

      return stats;
    }

    function displayDataQuality(deals, stats) {
      const tbody = document.getElementById('dataQualityTableBody');
      if (!tbody) return;

      const storeQuality = {};

      // Initialize all stores with zeros (so every store always shows)
      CANONICAL_STORES.forEach(store => {
        storeQuality[store] = {
          totalDeals: 0,
          unknownBrands: 0,
          unknownModels: 0,
          noPrice: 0,
          noSalePrice: 0,
          badImage: 0,
          badUrl: 0
        };
      });

      // Include Unknown if present in stats (optional)
      if (stats?.stores?.Unknown && !storeQuality['Unknown']) {
        storeQuality['Unknown'] = {
          totalDeals: 0,
          unknownBrands: 0,
          unknownModels: 0,
          noPrice: 0,
          noSalePrice: 0,
          badImage: 0,
          badUrl: 0
        };
      }

      deals.forEach(deal => {
        const store = (deal.store || 'Unknown').trim() || 'Unknown';

        if (!storeQuality[store]) {
          storeQuality[store] = {
            totalDeals: 0,
            unknownBrands: 0,
            unknownModels: 0,
            noPrice: 0,
            noSalePrice: 0,
            badImage: 0,
            badUrl: 0
          };
        }

        storeQuality[store].totalDeals++;

        const brand = (deal.brand || '').trim();
        if (!brand || brand === 'Unknown') storeQuality[store].unknownBrands++;

        const model = (deal.model || '').trim();
        if (!model) storeQuality[store].unknownModels++;

        const price = Number(deal.price);
        if (!price || price === 0) storeQuality[store].noPrice++;

        const salePrice = Number(deal.salePrice);
        if (!salePrice || salePrice === 0) storeQuality[store].noSalePrice++;

        if (!deal.image || deal.image.includes('placehold.co') || deal.image.trim() === '') {
          storeQuality[store].badImage++;
        }

        if (!deal.url || deal.url === '#' || deal.url.trim() === '') {
          storeQuality[store].badUrl++;
        }
      });

      renderDataQualityTable(storeQuality);
    }

    function renderDataQualityTable(storeQuality) {
      const tbody = document.getElementById('dataQualityTableBody');
      if (!tbody) return;

      const entries = Object.entries(storeQuality).map(([store, data]) => ({ store, ...data }));
      sortDataQualityArray(entries, CURRENT_DATA_QUALITY_SORT.column, CURRENT_DATA_QUALITY_SORT.direction);

      tbody.innerHTML = entries.map(row => {
        const getIssueClass = (count, total) => {
          const percent = total > 0 ? (count / total) * 100 : 0;
          if (count === 0) return 'good';
          if (percent > 20) return 'critical';
          if (percent > 5) return 'warning';
          return '';
        };

        return `
          <tr>
            <td><strong>${row.store}</strong></td>
            <td>${row.totalDeals.toLocaleString()}</td>
            <td><span class="issue-count ${getIssueClass(row.unknownBrands, row.totalDeals)}">${row.unknownBrands}</span></td>
            <td><span class="issue-count ${getIssueClass(row.unknownModels, row.totalDeals)}">${row.unknownModels}</span></td>
            <td><span class="issue-count ${getIssueClass(row.noPrice, row.totalDeals)}">${row.noPrice}</span></td>
            <td><span class="issue-count ${getIssueClass(row.noSalePrice, row.totalDeals)}">${row.noSalePrice}</span></td>
            <td><span class="issue-count ${getIssueClass(row.badImage, row.totalDeals)}">${row.badImage}</span></td>
            <td><span class="issue-count ${getIssueClass(row.badUrl, row.totalDeals)}">${row.badUrl}</span></td>
          </tr>
        `;
      }).join('');
    }

    function sortDataQuality(column) {
      if (CURRENT_DATA_QUALITY_SORT.column === column) {
        CURRENT_DATA_QUALITY_SORT.direction = CURRENT_DATA_QUALITY_SORT.direction === 'asc' ? 'desc' : 'asc';
      } else {
        CURRENT_DATA_QUALITY_SORT.column = column;
        CURRENT_DATA_QUALITY_SORT.direction = column === 'store' ? 'asc' : 'desc';
      }
      // Re-render from current ALL_DEALS
      const stats = calculateStats(ALL_DEALS);
      displayDataQuality(ALL_DEALS, stats);
    }

    function sortDataQualityArray(arr, column, direction) {
      arr.sort((a, b) => {
        let aVal, bVal;

        switch(column) {
          case 'store':
            aVal = a.store.toLowerCase();
            bVal = b.store.toLowerCase();
            return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          default:
            aVal = a[column] || 0;
            bVal = b[column] || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
      });
    }

    function sortStoreTable(column) {
      if (CURRENT_STORE_SORT.column === column) {
        CURRENT_STORE_SORT.direction = CURRENT_STORE_SORT.direction === 'asc' ? 'desc' : 'asc';
      } else {
        CURRENT_STORE_SORT.column = column;
        CURRENT_STORE_SORT.direction = column === 'name' ? 'asc' : 'desc';
      }
      displayStoreTable(STORE_DATA);
    }

    function displayStoreTable(stores) {
      const tbody = document.getElementById('storesTableBody');
      if (!tbody || !stores) return;

      let sorted = Object.entries(stores).map(([name, data]) => {
        const avgDiscount = data.count > 0 ? (data.totalDiscount / data.count) : 0;
        const avgSavings = data.count > 0 ? (data.totalSavings / data.count) : 0;

        const bestDeal = (data.deals || [])
          .map(d => {
            const price = Number(d.price) || 0;
            const salePrice = Number(d.salePrice) || 0;
            const pct = (price > salePrice && price > 0) ? ((price - salePrice) / price) * 100 : 0;
            return { deal: d, pct };
          })
          .sort((a, b) => b.pct - a.pct)[0];

        return { name, data, avgDiscount, avgSavings, bestDeal };
      });

      sorted.sort((a, b) => {
        let comparison = 0;
        switch(CURRENT_STORE_SORT.column) {
          case 'name':
            comparison = a.name.toLowerCase().localeCompare(b.name.toLowerCase());
            break;
          case 'count':
            comparison = a.data.count - b.data.count;
            break;
          case 'avgDiscount':
            comparison = a.avgDiscount - b.avgDiscount;
            break;
          case 'avgSavings':
            comparison = a.avgSavings - b.avgSavings;
            break;
        }
        return CURRENT_STORE_SORT.direction === 'asc' ? comparison : -comparison;
      });

      // Update header classes (only within Store Breakdown table)
      const storeTable = document.querySelectorAll('.stores-table')[1]; // 0 = data quality, 1 = store breakdown
      if (storeTable) {
        storeTable.querySelectorAll('th').forEach(th => th.classList.remove('sorted-asc', 'sorted-desc'));
        const headers = storeTable.querySelectorAll('th');
        const columnMap = { name: 0, count: 1, avgDiscount: 2, avgSavings: 3 };
        if (columnMap[CURRENT_STORE_SORT.column] !== undefined) {
          headers[columnMap[CURRENT_STORE_SORT.column]].classList.add(
            CURRENT_STORE_SORT.direction === 'asc' ? 'sorted-asc' : 'sorted-desc'
          );
        }
      }

      tbody.innerHTML = sorted.map(({ name, data, avgDiscount, avgSavings, bestDeal }) => `
        <tr>
          <td><strong>${name}</strong></td>
          <td>${(data.count || 0).toLocaleString()}</td>
          <td>${avgDiscount.toFixed(1)}%</td>
          <td>$${avgSavings.toFixed(2)}</td>
          <td>${bestDeal ? `${bestDeal.deal.brand || 'Unknown'} ${(bestDeal.deal.model || '')} (${bestDeal.pct.toFixed(0)}% off)` : '-'}</td>
        </tr>
      `).join('');
    }

    function displayHealthStatus(deals, stats, mergeData) {
      const healthPanel = document.getElementById('healthPanel');
      const healthGrid = document.getElementById('healthGrid');
      const healthSummary = document.getElementById('healthSummary');
      if (!healthPanel || !healthGrid || !healthSummary) return;

      const storeMetadata = mergeData?.storeMetadata || {};

      const storeToScraperName = {
        'ASICS': 'ASICS Sale',
        'Brooks Running': 'Brooks Sale',
        'Holabird Sports': ['Holabird Mens Road', 'Holabird Womens Road', 'Holabird Trail + Unisex']
      };

      const storeHealth = {};
      let healthyCount = 0;
      let warningCount = 0;
      let criticalCount = 0;

      // Use canonical stores so all stores always show (even if 0)
      CANONICAL_STORES.forEach(storeName => {
        const storeData = stats.stores[storeName] || { count: 0, deals: [], totalDiscount: 0, totalSavings: 0 };

        const health = {
          store: storeName,
          dealCount: storeData.count || 0,
          issues: [],
          status: 'healthy',
          metadata: null,
          scrapedUrl: SCRAPER_URLS[storeName] || null
        };

        // Metadata selection
        if (storeToScraperName[storeName]) {
          const scraperNames = Array.isArray(storeToScraperName[storeName])
            ? storeToScraperName[storeName]
            : [storeToScraperName[storeName]];

          const scraperMetas = scraperNames.map(name => storeMetadata[name]).filter(Boolean);

          if (scraperMetas.length > 0) {
            const timestamps = scraperMetas.map(m => m.timestamp).filter(Boolean);
            const mostRecent = timestamps.length > 0 ? timestamps.sort().reverse()[0] : null;

            const durations = scraperMetas.map(m => m.duration).filter(Boolean);
            const combinedDuration = durations.length > 0 ? durations.join(', ') : null;

            health.metadata = {
              timestamp: mostRecent,
              duration: combinedDuration,
              count: storeData.count
            };
          }
        } else {
          const otherMeta = storeMetadata['Other (scrape-daily)'];
          if (otherMeta) {
            health.metadata = {
              timestamp: otherMeta.timestamp,
              duration: otherMeta.duration,
              count: storeData.count
            };
          }
        }

        const storeDeals = deals.filter(d => (d.store || 'Unknown').trim() === storeName);

        // Health checks
        if (storeData.count === 0) {
          health.issues.push({ type: 'critical', message: 'üö® ZERO RESULTS - Scraper may be broken' });
          health.status = 'critical';
        }

        const unknownBrands = storeDeals.filter(d => (d.brand || '').trim() === 'Unknown' || !(d.brand || '').trim()).length;
        const unknownPercent = storeData.count > 0 ? (unknownBrands / storeData.count) * 100 : 0;

        if (unknownPercent > 50) {
          health.issues.push({ type: 'critical', message: `üö® ${unknownPercent.toFixed(0)}% Unknown Brands` });
          health.status = 'critical';
        } else if (unknownPercent > 20) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${unknownPercent.toFixed(0)}% Unknown Brands` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        const missingImages = storeDeals.filter(d => !d.image || d.image.includes('placehold.co')).length;
        const missingImagesPercent = storeData.count > 0 ? (missingImages / storeData.count) * 100 : 0;

        if (missingImagesPercent > 30) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingImagesPercent.toFixed(0)}% Missing Images` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        const missingUrls = storeDeals.filter(d => !d.url || d.url === '#').length;
        const missingUrlsPercent = storeData.count > 0 ? (missingUrls / storeData.count) * 100 : 0;

        if (missingUrlsPercent > 10) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingUrlsPercent.toFixed(0)}% Missing URLs` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        const missingPrices = storeDeals.filter(d => !d.salePrice || Number(d.salePrice) === 0).length;
        if (missingPrices > 0) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingPrices} Missing Prices` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        const missingModels = storeDeals.filter(d => !d.model || d.model.trim() === '').length;
        const missingModelsPercent = storeData.count > 0 ? (missingModels / storeData.count) * 100 : 0;

        if (missingModelsPercent > 30) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è ${missingModelsPercent.toFixed(0)}% Missing Models` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        if (storeData.count > 0 && storeData.count < 5) {
          health.issues.push({ type: 'warning', message: `‚ö†Ô∏è Low Deal Count (${storeData.count})` });
          if (health.status !== 'critical') health.status = 'warning';
        }

        storeHealth[storeName] = health;

        if (health.status === 'healthy') healthyCount++;
        else if (health.status === 'warning') warningCount++;
        else if (health.status === 'critical') criticalCount++;
      });

      healthSummary.innerHTML = `
        <div class="health-summary-item healthy">${healthyCount} Healthy</div>
        <div class="health-summary-item warning">${warningCount} Warnings</div>
        <div class="health-summary-item critical">${criticalCount} Critical</div>
      `;

      // Alphabetical order (as requested)
      const sortedStores = Object.values(storeHealth).sort((a, b) =>
        a.store.toLowerCase().localeCompare(b.store.toLowerCase())
      );

      healthGrid.innerHTML = sortedStores.map(health => {
        const meta = health.metadata;
        const hasMetadata = meta && !meta.error;

        let timestampStr = 'Not Available';
        if (hasMetadata && meta.timestamp) {
          const d = new Date(meta.timestamp);
          timestampStr = Number.isFinite(d.getTime()) ? d.toLocaleString() : String(meta.timestamp);
        }

        let durationStr = 'Not Available';
        if (hasMetadata && meta.duration) durationStr = meta.duration;

        const scrapedUrlStr = health.scrapedUrl || 'Not Available';

        // Gender stats
        const storeDeals = ALL_DEALS.filter(d => (d.store || 'Unknown').trim() === health.store);
        const genderStats = calculateGenderStats(storeDeals);

        // Total Deals moved into "Gender Breakdown" title area (and breakdown below it)
        const totalDealsStr = (health.dealCount || 0).toLocaleString();

        return `
          <div class="health-card ${health.status}">
            <div class="health-header">
              <div class="health-store-name">${health.store}</div>
              <div class="health-status-badge ${health.status}">
                ${health.status === 'healthy' ? '‚úì Healthy' : health.status === 'warning' ? '‚ö† Warning' : '‚úó Critical'}
              </div>
            </div>

            <div class="scraped-url">
              <strong>Scraped URL:</strong> ${scrapedUrlStr !== 'Not Available'
                ? `<a href="${scrapedUrlStr}" target="_blank" rel="noopener noreferrer">${scrapedUrlStr}</a>`
                : scrapedUrlStr}
            </div>

            <div class="health-metrics">
              <div class="health-metric full">
                <div class="health-metric-label">Last Updated ‚Ä¢ Scrape Duration</div>
                <div class="health-metric-value ${timestampStr === 'Not Available' ? 'na' : ''}" style="font-size: 0.86rem;">
                  <span class="inline-pair">
                    <span>${timestampStr}</span>
                    <span style="opacity:.65;">|</span>
                    <span class="${durationStr === 'Not Available' ? 'na' : ''}">${durationStr}</span>
                  </span>
                </div>
              </div>
            </div>

            <div class="gender-breakdown">
              <div class="gender-breakdown-title">
                <span>Total Deals: ${totalDealsStr}</span>
                <span class="gender-breakdown-subtitle">Gender Breakdown</span>
              </div>

              <div class="gender-stats">
                <div class="gender-stat">
                  <span class="gender-stat-label">Men's:</span>
                  <span class="gender-stat-value">${genderStats.mens}</span>
                </div>
                <div class="gender-stat">
                  <span class="gender-stat-label">Women's:</span>
                  <span class="gender-stat-value">${genderStats.womens}</span>
                </div>
                <div class="gender-stat">
                  <span class="gender-stat-label">Unisex:</span>
                  <span class="gender-stat-value">${genderStats.unisex}</span>
                </div>
                <div class="gender-stat">
                  <span class="gender-stat-label">Unknown:</span>
                  <span class="gender-stat-value">${genderStats.unknown}</span>
                </div>
              </div>
            </div>

            ${health.issues.length > 0 ? `
              <div class="health-issues">
                ${health.issues.map(issue => `
                  <div class="health-issue ${issue.type}">
                    <span>${issue.message}</span>
                  </div>
                `).join('')}
              </div>
            ` : '<div style="margin-top: 10px; color: #28a745; font-weight: bold;">‚úì All checks passed</div>'}
          </div>
        `;
      }).join('');

      healthPanel.style.display = 'block';

      // Also update Store Breakdown after health is built (so it reflects canonical stores too)
      displayStoreTable(stats.stores);
    }

    function formatMoney(n) {
      const x = Number(n);
      return Number.isFinite(x) ? `$${x.toFixed(2)}` : "‚Äî";
    }

    function buildStoreDropdown(deals) {
      const select = document.getElementById("storeSelect");
      if (!select) return;

      select.innerHTML = `<option value="__none__" selected>Select store or Close</option>`;

      // Always show all canonical stores (even if 0)
      CANONICAL_STORES.forEach(store => {
        const opt = document.createElement("option");
        opt.value = store;
        opt.textContent = store;
        select.appendChild(opt);
      });

      select.addEventListener("change", () => renderDealsForSelectedStore());
    }

    function renderDealsForSelectedStore() {
      const select = document.getElementById("storeSelect");
      const grid = document.getElementById("storeDealsGrid");
      const countEl = document.getElementById("storeCount");
      if (!select || !grid) return;

      const chosen = select.value;
      let filtered = [];

      if (chosen === "__none__") filtered = [];
      else filtered = ALL_DEALS.filter(d => (d.store || "") === chosen);

      if (countEl) {
        if (chosen === "__none__") countEl.textContent = "";
        else countEl.textContent = `${filtered.length.toLocaleString()} deal${filtered.length === 1 ? "" : "s"}`;
      }

      const SHOW_MAX = 500;
      const toShow = filtered.slice(0, SHOW_MAX);

      grid.innerHTML = "";

      if (chosen === "__none__") return;

      if (!toShow.length) {
        grid.innerHTML = `<div style="text-align:center;color:#666;padding:18px;">No deals found for this store.</div>`;
        return;
      }

      toShow.forEach((d) => {
        const a = document.createElement("a");
        a.className = "deal-card";
        a.href = d.url || "#";
        a.target = "_blank";
        a.rel = "noopener noreferrer";

        const img = document.createElement("img");
        img.src = d.image || "https://placehold.co/600x400?text=Running+Shoe";
        img.alt = (d.brand && d.model) ? `${d.brand} ${d.model}` : (d.title || "Deal");
        a.appendChild(img);

        const body = document.createElement("div");
        body.className = "deal-card-body";

        const title = document.createElement("div");
        title.className = "deal-title";
        title.textContent = (d.brand || d.model)
          ? [d.brand, d.model].filter(Boolean).join(" ")
          : (d.title || "Deal");
        body.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "deal-meta";
        meta.textContent = d.store || "";
        body.appendChild(meta);

        const priceRow = document.createElement("div");
        priceRow.className = "deal-price-row";

        const priceSpan = document.createElement("div");
        priceSpan.className = "deal-price";
        priceSpan.textContent = formatMoney(d.salePrice);

        const price = Number(d.price);
        const salePrice = Number(d.salePrice);
        if (Number.isFinite(price) && Number.isFinite(salePrice) && price > salePrice) {
          const origSpan = document.createElement("span");
          origSpan.className = "deal-orig";
          origSpan.textContent = formatMoney(price);
          priceSpan.appendChild(origSpan);

          const discountPercent = ((price - salePrice) / price) * 100;
          const discountBadge = document.createElement("div");
          discountBadge.className = "deal-discount";
          discountBadge.textContent = `-${discountPercent.toFixed(0)}%`;
          priceRow.appendChild(priceSpan);
          priceRow.appendChild(discountBadge);
        } else {
          priceRow.appendChild(priceSpan);
        }

        body.appendChild(priceRow);
        a.appendChild(body);
        grid.appendChild(a);
      });
    }

    function openExternal(url) {
      window.open(url, "_blank", "noopener,noreferrer");
    }

    loadStats();
  </script>
</body>
</html>
