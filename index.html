<!-- /pages/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                 img-src * data: https:;
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self' https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com;
                 font-src 'self';
                 frame-src 'none';">
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS split -->
  <link rel="stylesheet" href="/pages/index.css?v=87">

  <!--
    IMPORTANT:
    Set this at deploy time to avoid hardcoding the blob store base.
    Example value:
      https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com
  -->
  <meta name="shoebeagle-blob-base" content="__BLOB_BASE_URL__">
</head>

<body>
  <div class="app">
    <img class="mobile-top-banner" src="/images/logo_heading.svg" alt="">

    <!-- TOP AREA: inputs left, logo right -->
    <div class="topbar">
      <div class="top-left">
        <form id="search-form" method="POST" autocomplete="off">

          <!-- BRAND ROW: input + links toggle button -->
          <div class="row">
            <div class="input-wrapper">
              <img class="input-icon" src="/images/mg.svg" alt="" aria-hidden="true">
              <input id="brand" type="text" placeholder="Brand Search..." autocomplete="off"/>
              <button type="button" class="input-clear" aria-label="Clear brand">&times;</button>
              <div id="brandSuggestions" class="suggestions"></div>
            </div>

            <div class="button-wrapper">
              <button id="menuBtn"
                      type="button"
                      class="btn-eq"
                      aria-label="Links"
                      aria-expanded="false"
                      aria-controls="linksRibbon">
                <img src="/images/menu.svg" class="btn-icon" alt="Links">
              </button>
            </div>
          </div>

          <!-- MODEL ROW: input + fetch -->
          <div class="row">
            <div class="input-wrapper">
              <img class="input-icon" src="/images/mg.svg" alt="" aria-hidden="true">
              <input id="model" type="text" placeholder="Model Search..." autocomplete="off"/>
              <button type="button" class="input-clear" aria-label="Clear model">&times;</button>
              <div id="modelSuggestions" class="suggestions"></div>
            </div>

            <div class="button-wrapper">
              <button id="fetchBtn" type="submit" class="btn-eq" aria-label="Fetch">
                <img src="/images/fetch.svg" class="btn-icon" alt="Fetch">
              </button>
            </div>
          </div>

        </form>
      </div>

      <!-- LOGO RIGHT -->
      <div class="top-right">
        <img
          src="/images/logo.svg"
          class="brand-logo"
          alt="Shoe Beagle Logo"
          id="logoLink"
        >
      </div>
    </div>

    <!-- Links ribbon (hidden by default; toggled by the button above) -->
    <div id="linksRibbon" class="links-ribbon" style="display:none;">
      <div class="links-ribbon-inner">

        <!-- LEFT: Set Alert -->
        <div class="links-ribbon-left">
          <a class="links-ribbon-link" href="#" data-open-alert>Set Alert</a>
        </div>

        <!-- CENTER: Filter + Sort dropdowns -->
        <div class="links-ribbon-center">
          <div class="ribbon-controls" role="group" aria-label="Filter and sort">
            <label class="ribbon-label" for="ribbonFilter">Filter:</label>
            <select id="ribbonFilter" class="ribbon-select" aria-label="Filter by gender">
              <option value="all" selected>All</option>
              <option value="mens">Mens only</option>
              <option value="womens">Womens only</option>
            </select>

            <label class="ribbon-label" for="ribbonSort">Sort:</label>
            <select id="ribbonSort" class="ribbon-select" aria-label="Sort results">
              <option value="none" selected>None</option>

              <option value="price_asc">Price: Low → High</option>
              <option value="price_desc">Price: High → Low</option>

              <option value="pct_asc">% Off: Low → High</option>
              <option value="pct_desc">% Off: High → Low</option>

              <option value="save_asc">$ Savings: Low → High</option>
              <option value="save_desc">$ Savings: High → Low</option>
            </select>
          </div>
        </div>

        <!-- RIGHT: Favorites + close -->
        <div class="links-ribbon-right">
          <a class="links-ribbon-link is-disabled" href="#" aria-disabled="true" tabindex="0">Favorites</a>
          <button type="button" class="chip-close" aria-label="Close links">×</button>
        </div>

      </div>
    </div>

    <div id="mainContent">

      <!-- (You can keep these chips if you want — dropdown will also drive gender filtering) -->
      <div class="filters" id="filters" style="display:none;">
        <div class="filter-row">
          <div class="filter-label">Gender:</div>
          <div class="chip-group" id="genderChips">
            <button type="button" class="chip active" data-gender="" aria-label="Filter off">&times;</button>
            <button type="button" class="chip" data-gender="mens" aria-label="Men's">M</button>
            <button type="button" class="chip" data-gender="womens" aria-label="Women's">W</button>
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-label">Shoe type:</div>
          <div class="chip-group" id="typeChips">
            <button type="button" class="chip active" data-type="" aria-label="Filter off">&times;</button>
            <button type="button" class="chip" data-type="road" aria-label="Road">R</button>
            <button type="button" class="chip" data-type="trail" aria-label="Trail">T</button>
            <button type="button" class="chip" data-type="track" aria-label="Spikes">S</button>
          </div>
        </div>
      </div>

      <div class="status-message" id="statusMessage">
        Marty’s Daily Deals
      </div>

      <div class="daily-deals" id="dailyDeals">
        <div class="shoe-grid" id="dailyDealsGrid"></div>
      </div>

      <div class="shoe-grid" id="results"></div>

      <div class="load-more-wrap" id="loadMoreWrap" style="display:none;">
        <button id="loadMoreBtn" class="load-more-btn" type="button">Load more</button>
      </div>

      <div class="pager">
        <button id="prevPage" class="pager-btn" aria-label="Previous page">◀</button>
        <div id="pageLabel" class="page-label">1 / 1</div>
        <button id="nextPage" class="pager-btn" aria-label="Next page">▶</button>
      </div>

      <p class="disclaimer">
        Shoe Beagle may earn commissions through our affiliate program at no cost to you.
        We do not sell products directly and are not responsible for changes in price, availability,
        or shipping terms on retailer sites.
      </p>

    </div>

    <div class="footer">
      <div class="footer-links">
        <a href="/pages/about.html">About</a> |
        <a href="/pages/contact.html">Contact</a> |
        <a href="/pages/privacy.html">Privacy</a> |
        <a href="/pages/terms.html">Terms</a>
      </div>

      <div class="footer-copy">
        © <span id="footerYear"></span> Shoe Beagle. All rights reserved.
      </div>
    </div>

    <button class="to-top" id="toTopBtn" type="button" aria-label="Back to top">↑</button>
  </div>

  <!-- Load brand/models once (root) -->
  <script src="/brandModels.js"></script>

  <!-- ===== Main Page Script ===== -->
  <script>
  (() => {
    const form = document.getElementById("search-form");

    const statusMessageEl = document.getElementById("statusMessage");
    const resultsEl = document.getElementById("results");
    const dailyDeals = document.getElementById("dailyDeals");
    const dailyDealsGrid = document.getElementById("dailyDealsGrid");
    const fetchBtn = document.getElementById("fetchBtn");
    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");
    const logoLink = document.getElementById("logoLink");
    const footerYear = document.getElementById("footerYear");
    const appEl = document.querySelector(".app");

    // Links toggle button + ribbon
    const menuBtn = document.getElementById("menuBtn");
    const linksRibbon = document.getElementById("linksRibbon");
    const linksRibbonClose = linksRibbon?.querySelector(".chip-close");

    // NEW: ribbon dropdowns
    const ribbonFilter = document.getElementById("ribbonFilter");
    const ribbonSort = document.getElementById("ribbonSort");

    const filtersEl = document.getElementById("filters");
    const genderChips = document.getElementById("genderChips");
    const typeChips = document.getElementById("typeChips");

    const PAGE_SIZE = 12;
    let pageIndex = 0;

    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageLabelEl = document.getElementById("pageLabel");

    // Load more elements
    const loadMoreWrap = document.getElementById("loadMoreWrap");
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const toTopBtn = document.getElementById("toTopBtn");

    function isMobilePortrait(){
      return window.matchMedia("(max-width: 560px) and (orientation: portrait)").matches;
    }

    function runPagerTransitionThen(fn){
      if (isMobilePortrait()) { fn(); return; }
      resultsEl.classList.add("is-switching");
      setTimeout(() => {
        fn();
        requestAnimationFrame(() => {
          resultsEl.classList.remove("is-switching");
        });
      }, 160);
    }

    let currentSearch = { brand: "", model: "" };
    let lastSearchResults = [];
    let lastDailyDeals = []; // NEW: so sort/filter can re-render daily deals too

    let selectedGender = "";      // chips gender (mens/womens/"")
    let selectedShoeType = "";    // chips shoeType (road/trail/track/"")
    let ribbonGenderMode = "all"; // NEW: all/mens/womens (unisex/unknown always allowed)
    let currentSort = "none";     // NEW

    if (footerYear) footerYear.textContent = new Date().getFullYear();
    if (logoLink) logoLink.addEventListener("click", () => location.reload());

    // --- Links ribbon toggle ---
    function isRibbonOpen(){
      return !!(linksRibbon && linksRibbon.style.display !== "none");
    }
    function openRibbon(){
      if (!linksRibbon) return;
      linksRibbon.style.display = "block";
      if (menuBtn) menuBtn.setAttribute("aria-expanded", "true");
    }
    function closeRibbon(){
      if (!linksRibbon) return;
      linksRibbon.style.display = "none";
      if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
    }
    function toggleRibbon(){
      if (!linksRibbon) return;
      if (isRibbonOpen()) closeRibbon();
      else openRibbon();
    }

    if (menuBtn) {
      menuBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleRibbon();
      });
    }

    if (linksRibbonClose) {
      linksRibbonClose.addEventListener("click", (e) => {
        e.preventDefault();
        closeRibbon();
      });
    }

    document.addEventListener("click", (e) => {
      if (!linksRibbon || linksRibbon.style.display === "none") return;
      const clickedInsideRibbon = linksRibbon.contains(e.target);
      const clickedButton = menuBtn && menuBtn.contains(e.target);
      if (!clickedInsideRibbon && !clickedButton) closeRibbon();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeRibbon();
    });

    if (linksRibbon) {
      linksRibbon.addEventListener("click", (e) => {
        const a = e.target.closest("a");
        if (a) closeRibbon();
      });
    }

    // make sure brandModels always exists
    const brandModels = window.brandModels || {};

    // --- Helpers ---
    function normalizeStr(s) { return String(s || "").trim().toLowerCase(); }
    function normalizeEnum(s) { return String(s || "").trim().toLowerCase(); }

    function sanitizeInput(str) {
      return String(str || "")
        .replace(/[<>'"]/g, '')
        .replace(/script/gi, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .trim()
        .slice(0, 100);
    }

    function updateFetchReady() {
      const hasAny = !!((brandInput && brandInput.value.trim()) || (modelInput && modelInput.value.trim()));
      if (fetchBtn) fetchBtn.disabled = !hasAny;
    }
    updateFetchReady();

    document.querySelectorAll('.input-clear').forEach((clearBtn, index) => {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const input = clearBtn.previousElementSibling;
        if (input && input.tagName === 'INPUT') {
          input.value = '';
          input.focus();
          if (index === 0) closeSuggestions("brand");
          else closeSuggestions("model");
          updateFetchReady();
        }
      });
    });

    function isValidRetailerUrl(url) {
      if (!url || url === '#') return false;
      try {
        const u = new URL(url);
        return u.protocol === "https:" || u.protocol === "http:";
      } catch {
        return false;
      }
    }

    // --- Blob base ---
    function getBlobBase() {
      const meta = document.querySelector('meta[name="shoebeagle-blob-base"]');
      const fromMeta = meta ? String(meta.getAttribute("content") || "").trim() : "";
      const looksLikePlaceholder = fromMeta.includes("__BLOB_BASE_URL__");
      if (fromMeta && !looksLikePlaceholder) return fromMeta.replace(/\/+$/, "");
      return "https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com";
    }

    function blobUrl(path) {
      const base = getBlobBase();
      const cleanPath = String(path || "").replace(/^\/+/, "");
      return base.replace(/\/+$/, "") + "/" + cleanPath;
    }

    // ===== Sort math helpers (price / % off / $ savings) =====
    function toNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function computePercentOff(item){
      const sale = toNum(item.salePrice);
      const orig = toNum(item.originalPrice);

      if (sale != null && orig != null && orig > 0 && sale < orig) {
        return ((orig - sale) / orig) * 100;
      }

      // fallback if upstream provides discountPercent
      const pct = toNum(item.discountPercent);
      if (pct != null && pct > 0 && pct < 100) return pct;

      return null;
    }

    function computeSavings(item){
      const sale = toNum(item.salePrice);
      const orig = toNum(item.originalPrice);
      if (sale != null && orig != null && orig > sale) return (orig - sale);
      return null;
    }

    function computePrice(item){
      const sale = toNum(item.salePrice);
      return sale;
    }

    function getSortValue(item, sortKey){
      if (!sortKey || sortKey === "none") return null;
      if (sortKey.startsWith("price_")) return computePrice(item);
      if (sortKey.startsWith("pct_")) return computePercentOff(item);
      if (sortKey.startsWith("save_")) return computeSavings(item);
      return null;
    }

    function sortItems(items){
      const sortKey = currentSort;
      if (!sortKey || sortKey === "none") return (items || []).slice();

      const desc = sortKey.endsWith("_desc");
      const out = (items || []).slice();

      out.sort((a,b) => {
        const va = getSortValue(a, sortKey);
        const vb = getSortValue(b, sortKey);

        // missing values go last
        const aMissing = (va == null);
        const bMissing = (vb == null);
        if (aMissing && bMissing) return 0;
        if (aMissing) return 1;
        if (bMissing) return -1;

        if (va === vb) return 0;
        return desc ? (vb - va) : (va - vb);
      });

      return out;
    }

    // ===== Ribbon gender filter rules =====
    // Requirement: Unisex/unknown/empty gender ALWAYS display, even when filtering mens/womens.
    function passesRibbonGender(item){
      const mode = String(ribbonGenderMode || "all");
      if (mode === "all") return true;

      const g = normalizeEnum(item.gender);
      if (!g || g === "unknown" || g === "unisex") return true;

      if (mode === "mens") return g === "mens";
      if (mode === "womens") return g === "womens";
      return true;
    }

    // ===== Existing discount badge helper =====
    function getDiscountInfo(item) {
      const current = Number(item.salePrice);
      const original = Number(item.originalPrice);

      if (Number.isFinite(current) && Number.isFinite(original) && original > 0 && current < original) {
        const pct = Math.round(((original - current) / original) * 100);
        return { hasDiscount: true, current: current.toFixed(2), original: original.toFixed(2), percent: pct };
      }

      const pct2 = Number(item.discountPercent);
      if (Number.isFinite(current) && Number.isFinite(pct2) && pct2 > 0 && pct2 < 100) {
        const origGuess = current / (1 - pct2 / 100);
        if (Number.isFinite(origGuess) && origGuess > current) {
          return { hasDiscount: true, current: current.toFixed(2), original: origGuess.toFixed(2), percent: Math.round(pct2) };
        }
        return { hasDiscount: true, current: current.toFixed(2), original: "", percent: Math.round(pct2) };
      }

      return { hasDiscount: false };
    }

    const brands = Object.keys(brandModels).sort((a,b) => a.localeCompare(b));

    function squashStr(s) { return String(s || "").toLowerCase().replace(/[^a-z0-9]/g, ""); }

    function scoreSuggestion(candidate, query) {
      const c = String(candidate || "");
      const cl = c.toLowerCase();
      const q = String(query || "").trim().toLowerCase();
      if (!q) return 0;

      const cSquash = squashStr(c);
      const qSquash = squashStr(q);

      let score = 0;
      if (cl.startsWith(q)) score += 120;
      if (cl.includes(q)) score += 80;
      if (qSquash.length >= 3 && cSquash.includes(qSquash)) score += 110;

      const qParts = q.split(/\s+/).filter(Boolean);
      if (qParts.length >= 2) {
        const cParts = cl.split(/\s+/);
        let tokenHits = 0;
        for (const qp of qParts) {
          if (cParts.some(cp => cp.startsWith(qp))) tokenHits++;
        }
        score += tokenHits * 25;
      }

      score -= Math.min(c.length, 30) * 0.25;
      return score;
    }

    function levenshtein(a, b) {
      a = String(a || "");
      b = String(b || "");
      const m = a.length, n = b.length;
      if (!m) return n;
      if (!n) return m;

      const dp = new Array(n + 1);
      for (let j = 0; j <= n; j++) dp[j] = j;

      for (let i = 1; i <= m; i++) {
        let prev = dp[0];
        dp[0] = i;
        for (let j = 1; j <= n; j++) {
          const temp = dp[j];
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[j] = Math.min(dp[j] + 1, dp[j - 1] + 1, prev + cost);
          prev = temp;
        }
      }
      return dp[n];
    }

    function resolveClosestBrand(input) {
      const raw = String(input || "").trim();
      if (!raw) return "";

      const exact = brands.find(b => normalizeStr(b) === normalizeStr(raw));
      if (exact) return exact;

      const q = squashStr(raw);
      if (!q) return raw;

      let best = null;
      let bestDist = Infinity;

      for (const b of brands) {
        const bs = squashStr(b);
        const d = levenshtein(q, bs);
        if (d < bestDist) {
          bestDist = d;
          best = b;
        }
      }

      const len = q.length;
      const threshold = len <= 4 ? 1 : (len <= 7 ? 2 : 3);
      return (best != null && bestDist <= threshold) ? best : raw;
    }

    function filterSuggestions(list, typed, limit = 10) {
      const q = String(typed || "").trim();
      if (!q) return [];

      const qLower = q.toLowerCase();
      const starts = list.filter(v => String(v).toLowerCase().startsWith(qLower));
      if (starts.length) {
        const ranked = starts
          .map(v => ({ v, s: scoreSuggestion(v, q) }))
          .sort((a, b) => b.s - a.s)
          .slice(0, limit)
          .map(x => x.v);
        return Array.from(new Set(ranked));
      }

      const scored = list
        .map(v => ({ v, s: scoreSuggestion(v, q) }))
        .filter(x => x.s > 0)
        .sort((a, b) => b.s - a.s)
        .slice(0, limit)
        .map(x => x.v);

      return Array.from(new Set(scored));
    }

    const allModels = (() => {
      const flat = [];
      for (const b of Object.keys(brandModels)) {
        const arr = brandModels[b];
        if (Array.isArray(arr)) flat.push(...arr);
      }
      return Array.from(new Set(flat)).sort((a, b) => a.localeCompare(b));
    })();

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }
    function resolveBrand() { return resolveBrandKey(brandInput.value.trim()); }

    const suggestionState = { openFor: null, items: [], activeIndex: -1 };

    function closeSuggestions(which) {
      if (!which || which === "brand") {
        brandSuggestions.style.display = "none";
        brandSuggestions.innerHTML = "";
      }
      if (!which || which === "model") {
        modelSuggestions.style.display = "none";
        modelSuggestions.innerHTML = "";
      }

      if (!which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      } else if (suggestionState.openFor === which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      }
    }

    function renderSuggestions(container, items, which, onPick) {
      container.innerHTML = "";

      if (!items.length) {
        container.style.display = "none";
        if (suggestionState.openFor === which) {
          suggestionState.openFor = null;
          suggestionState.items = [];
          suggestionState.activeIndex = -1;
        }
        return;
      }

      suggestionState.openFor = which;
      suggestionState.items = items.slice();
      suggestionState.activeIndex = -1;

      items.forEach((value, idx) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.dataset.index = String(idx);

        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onPick(value);
        });

        container.appendChild(div);
      });

      container.style.display = "block";
    }

    function highlightActive(container) {
      const children = Array.from(container.querySelectorAll(".suggestion-item"));
      children.forEach(el => el.classList.remove("active"));

      if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < children.length) {
        const active = children[suggestionState.activeIndex];
        active.classList.add("active");

        const box = container;
        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;
        if (top < box.scrollTop) box.scrollTop = top;
        else if (bottom > box.scrollTop + box.clientHeight) box.scrollTop = bottom - box.clientHeight;
      }
    }

    function handleSuggestionKeys(e, which, container, onPick) {
      if (suggestionState.openFor !== which) return;

      const max = suggestionState.items.length;
      if (!max) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex + 1) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex - 1 + max) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "Enter") {
        if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < max) {
          e.preventDefault();
          const value = suggestionState.items[suggestionState.activeIndex];
          onPick(value);
        }
        return;
      }

      if (e.key === "Escape") {
        e.preventDefault();
        closeSuggestions(which);
        return;
      }
    }

    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();
      if (typed.length < 1) {
        closeSuggestions("brand");
        updateFetchReady();
        return;
      }

      const matches = filterSuggestions(brands, typed, 12);
      renderSuggestions(brandSuggestions, matches, "brand", (value) => {
        brandInput.value = value;
        closeSuggestions("brand");
        setTimeout(() => modelInput.focus(), 0);
        updateFetchReady();
      });

      updateFetchReady();
    });

    brandInput.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "brand", brandSuggestions, (value) => {
        brandInput.value = value;
        closeSuggestions("brand");
        setTimeout(() => modelInput.focus(), 0);
        updateFetchReady();
      });
    });

    brandInput.addEventListener("blur", () => setTimeout(() => closeSuggestions("brand"), 140));

    modelInput.addEventListener("input", () => {
      const text = modelInput.value.trim();
      if (text.length < 1) {
        closeSuggestions("model");
        updateFetchReady();
        return;
      }

      const brandKey = resolveBrand();
      const pool = (brandKey && Array.isArray(brandModels[brandKey])) ? brandModels[brandKey] : allModels;

      const matches = filterSuggestions(pool, text, 12);
      renderSuggestions(modelSuggestions, matches, "model", (value) => {
        modelInput.value = value;
        closeSuggestions("model");
        setTimeout(() => fetchBtn.focus(), 0);
        updateFetchReady();
      });

      updateFetchReady();
    });

    modelInput.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "model", modelSuggestions, (value) => {
        modelInput.value = value;
        closeSuggestions("model");
        setTimeout(() => fetchBtn.focus(), 0);
        updateFetchReady();
      });
    });

    modelInput.addEventListener("blur", () => setTimeout(() => closeSuggestions("model"), 140));

    brandInput.addEventListener("click", () => brandInput.select());
    modelInput.addEventListener("click", () => modelInput.select());

    document.addEventListener("click", (e) => {
      const insideBrand = brandSuggestions.contains(e.target) || brandInput.contains(e.target);
      const insideModel = modelSuggestions.contains(e.target) || modelInput.contains(e.target);
      if (!insideBrand) closeSuggestions("brand");
      if (!insideModel) closeSuggestions("model");
    });

    function setActiveChip(groupEl, activeBtn) {
      if (!groupEl) return;
      groupEl.querySelectorAll(".chip").forEach(btn => btn.classList.remove("active"));
      if (activeBtn) activeBtn.classList.add("active");
    }

    // ===== Combined filtering: chips + ribbon =====
    function applyFilters(items) {
      const g = normalizeEnum(selectedGender);
      const t = normalizeEnum(selectedShoeType);

      return (items || []).filter(item => {
        // Ribbon gender rule first (All / Mens / Womens with unisex/unknown always allowed)
        if (!passesRibbonGender(item)) return false;

        // Existing chip behavior (kept):
        const itemGender = normalizeEnum(item.gender);
        const itemType = normalizeEnum(item.shoeType);

        const genderOk = !g || itemGender === g || itemGender === "unisex";
        const typeOk = !t || itemType === t;

        return genderOk && typeOk;
      });
    }

    function totalPagesCount(total){
      return Math.max(1, Math.ceil((Number(total) || 0) / PAGE_SIZE));
    }

    function updateNavUI(totalFiltered){
      const pager = document.querySelector(".pager");

      if (isMobilePortrait()){
        if (pager) pager.style.display = "none";
        const hasMore = ((pageIndex + 1) * PAGE_SIZE) < (Number(totalFiltered) || 0);
        if (loadMoreWrap) loadMoreWrap.style.display = hasMore ? "flex" : "none";
        return;
      }

      if (loadMoreWrap) loadMoreWrap.style.display = "none";

      const pages = totalPagesCount(totalFiltered);
      const current = Math.min(pageIndex + 1, pages);

      if (pageLabelEl) pageLabelEl.textContent = `${current} of ${pages}`;
      if (prevPageBtn) prevPageBtn.disabled = pageIndex <= 0;
      if (nextPageBtn) nextPageBtn.disabled = (pageIndex + 1) >= pages;

      if (pager) pager.style.display = (pages > 1) ? "flex" : "none";
    }

    function renderFilteredResults({ resetPage = true, append = false } = {}) {
      // filter then sort
      const filtered = applyFilters(lastSearchResults);
      const sorted = sortItems(filtered);

      if (resetPage) pageIndex = 0;

      const start = pageIndex * PAGE_SIZE;
      const slice = sorted.slice(start, start + PAGE_SIZE);

      if (!append) resultsEl.innerHTML = "";
      slice.forEach(item => resultsEl.appendChild(createDealCard(item)));

      const displayQuery =
        [currentSearch.brand, currentSearch.model].filter(Boolean).join(" ").trim() || "all shoes";

      if (!sorted.length) {
        statusMessageEl.textContent = `No results match your filters for ${displayQuery}.`;
        updateNavUI(0);
        return;
      }

      statusMessageEl.textContent =
        `We found ${sorted.length} deal${sorted.length === 1 ? "" : "s"} on ${displayQuery} shoes.`;

      updateNavUI(sorted.length);
    }

    // NEW: re-render daily deals with current filter/sort
    function renderDailyDealsNow(){
      if (!dailyDealsGrid) return;
      if (!lastDailyDeals || !lastDailyDeals.length) return;

      const filtered = applyFilters(lastDailyDeals);
      const sorted = sortItems(filtered);

      dailyDealsGrid.innerHTML = "";
      sorted.forEach(item => dailyDealsGrid.appendChild(createDealCard(item)));

      if (dailyDeals) dailyDeals.style.display = sorted.length ? "block" : "none";
    }

    // NEW: ribbon dropdown behavior
    function syncGenderChipsToRibbon(){
      // If ribbon says mens/womens, also select chip M/W (optional), but keep your chip “off” if ribbon=all.
      if (!genderChips) return;

      if (ribbonGenderMode === "all") {
        // do not force chips; leave as-is
        return;
      }

      const target = ribbonGenderMode === "mens" ? "mens" : "womens";
      const btn = genderChips.querySelector(`.chip[data-gender="${target}"]`);
      if (btn) {
        selectedGender = target;
        setActiveChip(genderChips, btn);
      }
    }

    if (ribbonFilter) {
      ribbonFilter.addEventListener("change", () => {
        ribbonGenderMode = String(ribbonFilter.value || "all");
        // Keep chips + ribbon compatible (optional sync)
        if (ribbonGenderMode === "all") {
          // do not override chips; but reset selectedGender to "" if you want ribbon to be the only gender control
          // selectedGender = "";
          // if (genderChips) setActiveChip(genderChips, genderChips.querySelector('.chip[data-gender=""]'));
        } else {
          syncGenderChipsToRibbon();
        }

        renderDailyDealsNow();
        renderFilteredResults({ resetPage: true, append: false });
      });
    }

    if (ribbonSort) {
      ribbonSort.addEventListener("change", () => {
        currentSort = String(ribbonSort.value || "none");
        renderDailyDealsNow();
        renderFilteredResults({ resetPage: true, append: false });
      });
    }

    if (loadMoreBtn) {
      loadMoreBtn.addEventListener("click", () => {
        const filtered = applyFilters(lastSearchResults);
        const sorted = sortItems(filtered);
        const total = sorted.length;

        const hasMore = ((pageIndex + 1) * PAGE_SIZE) < total;
        if (!hasMore) return;

        pageIndex++;
        renderFilteredResults({ resetPage: false, append: true });
      });
    }

    if (prevPageBtn) {
      prevPageBtn.addEventListener("click", () => {
        const filtered = applyFilters(lastSearchResults);
        const sorted = sortItems(filtered);
        if (pageIndex <= 0) return;

        runPagerTransitionThen(() => {
          pageIndex--;
          renderFilteredResults({ resetPage: false, append: false });
          resultsEl.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });
    }

    if (nextPageBtn) {
      nextPageBtn.addEventListener("click", () => {
        const filtered = applyFilters(lastSearchResults);
        const sorted = sortItems(filtered);
        const pages = totalPagesCount(sorted.length);
        if (pageIndex >= pages - 1) return;

        runPagerTransitionThen(() => {
          pageIndex++;
          renderFilteredResults({ resetPage: false, append: false });
          resultsEl.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });
    }

    if (genderChips) {
      genderChips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if (!btn) return;
        selectedGender = normalizeEnum(btn.dataset.gender);
        setActiveChip(genderChips, btn);
        renderDailyDealsNow();
        renderFilteredResults({ resetPage: true, append: false });
      });
    }

    if (typeChips) {
      typeChips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if (!btn) return;
        selectedShoeType = normalizeEnum(btn.dataset.type);
        setActiveChip(typeChips, btn);
        renderDailyDealsNow();
        renderFilteredResults({ resetPage: true, append: false });
      });
    }

    function createDealCard(item) {
      const discount = getDiscountInfo(item);

      const card = document.createElement("div");
      card.className = "card";

      const link = document.createElement("a");
      link.className = "card-link";

      const listingUrl = item.listingURL;
      const safeLink = isValidRetailerUrl(listingUrl) ? listingUrl : "#";
      if (safeLink === "#" && listingUrl) console.warn("Blocked untrusted retailer URL:", listingUrl);

      link.href = safeLink;
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      const imgWrapper = document.createElement("div");
      imgWrapper.className = "card-image-wrapper";

      const img = document.createElement("img");
      img.src = item.imageURL ? item.imageURL : "https://placehold.co/600x400?text=Running+Shoe";
      img.alt = (item.brand && item.model) ? `${item.brand} ${item.model}` : (item.model || item.brand || "Running shoe deal");
      imgWrapper.appendChild(img);

      if (discount.hasDiscount) {
        const badge = document.createElement("div");
        badge.className = "discount-badge";
        badge.textContent = `${discount.percent}% OFF`;
        imgWrapper.appendChild(badge);
      }

      const gRaw = normalizeEnum(item.gender);
      const tRaw = normalizeEnum(item.shoeType);

      const g = (gRaw && gRaw !== "unknown") ? gRaw : "";
      const t = (tRaw && tRaw !== "unknown") ? tRaw : "";

      const tagWrap = document.createElement("div");
      tagWrap.className = "card-tags";

      let hasAnyTag = false;

      if (g) {
        const genderTag = document.createElement("span");
        genderTag.className = "card-tag";
        genderTag.textContent = g === "mens" ? "Mens" : g === "womens" ? "Womens" : "Unisex";
        tagWrap.appendChild(genderTag);
        hasAnyTag = true;
      }

      if (t) {
        const typeTag = document.createElement("span");
        typeTag.className = "card-tag";
        typeTag.textContent =
          t === "road" ? "Road" :
          t === "trail" ? "Trail" :
          t === "track" ? "Spikes" : (item.shoeType || "");
        tagWrap.appendChild(typeTag);
        hasAnyTag = true;
      }

      if (hasAnyTag) imgWrapper.appendChild(tagWrap);

      link.appendChild(imgWrapper);

      const contentDiv = document.createElement("div");
      contentDiv.className = "card-content";

      const titleDiv = document.createElement("div");
      titleDiv.className = "card-title";

      const brand = (item.brand || "").trim();
      const model = (item.model || "").trim();

      if (brand && model) {
        titleDiv.innerHTML = `<strong style="text-transform: uppercase;">${brand}</strong><br>${model}`;
      } else if (brand) {
        titleDiv.innerHTML = `<strong style="text-transform: uppercase;">${brand}</strong>`;
      } else if (model) {
        titleDiv.textContent = model;
      } else {
        titleDiv.textContent = "Deal";
      }

      contentDiv.appendChild(titleDiv);

      if (item.store) {
        const storeDiv = document.createElement("div");
        storeDiv.className = "card-store";
        storeDiv.textContent = item.store;
        contentDiv.appendChild(storeDiv);
      }

      const priceRow = document.createElement("div");
      priceRow.className = "card-price-row";

      const priceSpan = document.createElement("span");
      priceSpan.className = "price";

      const currentPrice = Number(item.salePrice);
      if (Number.isFinite(currentPrice)) priceSpan.textContent = `$${currentPrice.toFixed(2)}`;
      else priceSpan.textContent = item.salePrice != null ? String(item.salePrice) : "—";

      priceRow.appendChild(priceSpan);

      if (discount.hasDiscount && discount.original) {
        const origSpan = document.createElement("span");
        origSpan.className = "card-original-price";
        origSpan.textContent = `$${discount.original}`;
        priceRow.appendChild(origSpan);
      }

      contentDiv.appendChild(priceRow);
      link.appendChild(contentDiv);

      card.appendChild(link);
      return card;
    }

    async function loadDailyDeals() {
      try {
        const url = blobUrl("twelve_daily_deals.json");
        const res = await fetch(url);

        if (!res.ok) {
          console.error("Failed to fetch daily deals:", res.status, res.statusText);
          if (dailyDeals) dailyDeals.style.display = "none";
          return;
        }

        const data = await res.json();
        const deals = Array.isArray(data.deals) ? data.deals : [];
        lastDailyDeals = deals.slice(); // keep a copy for ribbon sorting/filtering

        if (!deals.length) {
          if (dailyDeals) dailyDeals.style.display = "none";
          return;
        }

        renderDailyDealsNow();
        if (dailyDeals) dailyDeals.style.display = "block";
      } catch (err) {
        console.error("Error loading daily deals:", err);
        if (dailyDeals) dailyDeals.style.display = "none";
      }
    }

    loadDailyDeals();

    function updateToTopVisibility(){
      if (!toTopBtn) return;

      if (!isMobilePortrait()){
        toTopBtn.classList.remove("is-visible");
        return;
      }

      if (window.scrollY > 250)
        toTopBtn.classList.add("is-visible");
      else
        toTopBtn.classList.remove("is-visible");
    }

    window.addEventListener("scroll", updateToTopVisibility, { passive: true });
    window.addEventListener("resize", updateToTopVisibility);
    updateToTopVisibility();

    if (toTopBtn){
      toTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    function expandInputs(){
      if (!appEl) return;
      if (!isMobilePortrait()) return;
      appEl.classList.add("inputs-expanded");
    }

    function shrinkInputs(){
      if (!appEl) return;
      if (!isMobilePortrait()) return;

      const brand = document.getElementById("brand");
      const model = document.getElementById("model");
      const inputs = [brand, model].filter(Boolean);

      setTimeout(() => {
        const stillFocused = inputs.includes(document.activeElement);
        const anyText = inputs.some(i => (i.value || "").trim().length > 0);

        if (stillFocused) return;
        if (anyText) return;

        appEl.classList.remove("inputs-expanded");
      }, 0);
    }

    if (brandInput) brandInput.addEventListener("focus", expandInputs);
    if (modelInput) modelInput.addEventListener("focus", expandInputs);
    if (brandInput) brandInput.addEventListener("blur", shrinkInputs);
    if (modelInput) modelInput.addEventListener("blur", shrinkInputs);

    document.addEventListener("focusin", () => {
      if (!isMobilePortrait()) return;
      const active = document.activeElement;
      const inInputs = (active === brandInput || active === modelInput);
      if (!inInputs) shrinkInputs();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      shrinkInputs();

      let brandTyped = sanitizeInput(brandInput.value);
      brandTyped = resolveClosestBrand(brandTyped);
      brandInput.value = brandTyped;

      const modelTyped = sanitizeInput(modelInput.value);

      updateFetchReady();

      if (!brandTyped && !modelTyped) {
        statusMessageEl.textContent = "Please enter a brand and/or a model.";
        return;
      }

      currentSearch = { brand: brandTyped, model: modelTyped };
      const displayQuery = [brandTyped, modelTyped].filter(Boolean).join(" ").trim();
      if (!displayQuery) {
        statusMessageEl.textContent = "Please enter a brand and/or a model.";
        return;
      }

      statusMessageEl.textContent = "Searching deals…";
      resultsEl.innerHTML = "";

      const pager = document.querySelector(".pager");
      if (pager) pager.style.display = "none";
      if (loadMoreWrap) loadMoreWrap.style.display = "none";

      if (dailyDeals) dailyDeals.style.display = "none";
      if (filtersEl) filtersEl.style.display = "none";

      let data;
      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query: displayQuery }));
        data = await res.json();
      } catch (err) {
        console.error("Search error:", err);
        statusMessageEl.textContent = "Search failed. Please try again.";
        if (dailyDeals) dailyDeals.style.display = "block";
        return;
      }

      const results = (data && data.results) ? data.results : [];
      lastSearchResults = results;

      selectedGender = "";
      selectedShoeType = "";
      if (genderChips) setActiveChip(genderChips, genderChips.querySelector('.chip[data-gender=""]'));
      if (typeChips) setActiveChip(typeChips, typeChips.querySelector('.chip[data-type=""]'));

      if (!results.length) {
        statusMessageEl.textContent = `No results found for ${displayQuery}.`;
        if (filtersEl) filtersEl.style.display = "none";
        if (pager) pager.style.display = "none";
        if (loadMoreWrap) loadMoreWrap.style.display = "none";
        if (dailyDeals) dailyDeals.style.display = "block";
        return;
      }

      const genderRow = genderChips ? genderChips.closest(".filter-row") : null;
      if (genderRow) genderRow.style.display = "flex";

      const typeRow = typeChips ? typeChips.closest(".filter-row") : null;

      const hasBrand = !!brandTyped.trim();
      const hasModel = !!modelTyped.trim();

      if (typeRow) {
        if (hasBrand && !hasModel) {
          typeRow.style.display = "flex";
          if (typeChips) setActiveChip(typeChips, typeChips.querySelector('.chip[data-type=""]'));
        } else {
          typeRow.style.display = "none";
          selectedShoeType = "";
        }
      }

      if (filtersEl) filtersEl.style.display = "flex";
      renderFilteredResults({ resetPage: true, append: false });
    });

    brandInput.addEventListener("input", updateFetchReady);
    modelInput.addEventListener("input", updateFetchReady);
  })();
  </script>

  <!-- ===== Set Alert Modal (drop-in) ===== -->
  <div id="sbAlertBackdrop" class="sb-alert-backdrop" aria-hidden="true">
    <div class="sb-alert-modal" role="dialog" aria-modal="true" aria-labelledby="sbAlertTitle">
      <button type="button" class="sb-alert-close" id="sbAlertClose" aria-label="Close">×</button>

      <div class="sb-alert-title" id="sbAlertTitle">Set Alert</div>

      <form id="sbSetAlertForm" class="sb-alert-form">
        <!-- FORM VIEW -->
        <div id="sbAlertFormView">
          <input class="sb-input" type="email" id="sbAlertEmail" placeholder="your@email.com" required autocomplete="email">

          <div class="sb-input-wrap">
            <input class="sb-input" type="text" id="sbAlertBrand" placeholder="Enter shoe brand..." autocomplete="off" required>
            <button type="button" class="sb-clear" data-clear="#sbAlertBrand" aria-label="Clear brand">×</button>
            <div id="sbBrandSug" class="sb-sug" hidden></div>
          </div>

          <div class="sb-input-wrap">
            <input class="sb-input" type="text" id="sbAlertModel" placeholder="Enter shoe model..." autocomplete="off" required>
            <button type="button" class="sb-clear" data-clear="#sbAlertModel" aria-label="Clear model">×</button>
            <div id="sbModelSug" class="sb-sug" hidden></div>
          </div>

          <div class="sb-row">
            <div class="sb-col">
              <div class="sb-gender" id="sbGender">
                <div class="sb-gender-option" data-g="womens" role="radio" aria-checked="false" tabindex="0">
                  <span class="sb-gender-box"><span class="sb-gender-check">✓</span></span>
                  <span class="sb-gender-label">Women’s</span>
                </div>
                <div class="sb-gender-option" data-g="mens" role="radio" aria-checked="false" tabindex="0">
                  <span class="sb-gender-box"><span class="sb-gender-check">✓</span></span>
                  <span class="sb-gender-label">Men’s</span>
                </div>
              </div>
            </div>

            <div class="sb-col sb-price-col">
              <div class="sb-price-wrap">
                <span class="sb-dollar">$</span>
                <input class="sb-input sb-price"
                       type="text"
                       id="sbAlertPrice"
                       placeholder="Enter whole dollars."
                       inputmode="numeric"
                       autocomplete="off"
                       aria-label="Target price in whole dollars"
                       required>

                <button type="button" class="sb-clear sb-clear-price" data-clear="#sbAlertPrice" aria-label="Clear price">×</button>
              </div>
            </div>
          </div>

          <button type="submit" class="sb-submit" id="sbSetAlertBtn">Set Alert</button>

          <div class="sb-note">
            <div class="sb-note-title">Important</div>
            <ul>
              <li>Your email will never be sold or shared by Shoe Beagle, and will only be used for confirmation and notifications.</li>
            </ul>
          </div>

          <div id="sbStatus" class="sb-status" hidden></div>
        </div>

        <!-- SUCCESS VIEW -->
        <div id="sbConfirm" class="sb-confirm" hidden>
          <div class="sb-confirm-title">✓ Alert Set Successfully!</div>
          <div id="sbConfirmDetails" class="sb-confirm-details"></div>
          <div class="sb-confirm-msg">
            You’ll receive a confirmation email shortly. If we find your shoes at or below your target price, we’ll email you immediately. This alert expires in 30 days.
          </div>
          <button type="button" class="sb-submit sb-secondary" id="sbSetAnother">Set Another Alert</button>
        </div>

        <!-- MAXED OUT VIEW -->
        <div id="sbMaxed" class="sb-confirm" hidden>
          <div class="sb-confirm-title">Alert Limit Reached</div>
          <div class="sb-confirm-details" style="border-color: rgba(220,53,69,0.35);">
            <div style="font-weight:800; color:#214478ff; margin-bottom:6px;">You’ve reached the maximum number of alerts.</div>
            <div style="line-height:1.45;">
              If you want to set another alert, open your confirmation email and use the secure link inside it to remove an existing alert first.
            </div>
          </div>
          <button type="button" class="sb-submit sb-secondary" id="sbMaxedClose">Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Modal controller (unchanged logic from your current working version) ===== -->
  <script>
  (() => {
    const openers = document.querySelectorAll("[data-open-alert]");

    const backdrop = document.getElementById("sbAlertBackdrop");
    const closeBtn = document.getElementById("sbAlertClose");
    const form = document.getElementById("sbSetAlertForm");

    const formView = document.getElementById("sbAlertFormView");
    const confirmBox = document.getElementById("sbConfirm");
    const confirmDetails = document.getElementById("sbConfirmDetails");
    const setAnother = document.getElementById("sbSetAnother");

    const maxedBox = document.getElementById("sbMaxed");
    const maxedClose = document.getElementById("sbMaxedClose");

    const emailEl = document.getElementById("sbAlertEmail");
    const brandEl = document.getElementById("sbAlertBrand");
    const modelEl = document.getElementById("sbAlertModel");
    const priceEl = document.getElementById("sbAlertPrice");

    const brandSug = document.getElementById("sbBrandSug");
    const modelSug = document.getElementById("sbModelSug");

    const genderWrap = document.getElementById("sbGender");
    const btn = document.getElementById("sbSetAlertBtn");

    const status = document.getElementById("sbStatus");

    const API_ALERTS = "/api/alerts";

    const brandModels = window.brandModels || {};
    const brands = Object.keys(brandModels).sort((a,b) => a.localeCompare(b));
    const allModels = (() => {
      const flat = [];
      for (const b of Object.keys(brandModels)) {
        const arr = brandModels[b];
        if (Array.isArray(arr)) flat.push(...arr);
      }
      return Array.from(new Set(flat)).sort((a,b) => a.localeCompare(b));
    })();

    if (!backdrop || !closeBtn || !form || !emailEl || !brandEl || !modelEl || !priceEl || !genderWrap) return;

    let lastFocus = null;
    let busy = false;
    let selectedGender = "";

    function setBusy(v){
      busy = v;
      if (btn) btn.disabled = v;
      if (btn) btn.textContent = v ? "Setting..." : "Set Alert";
    }

    function hideStatus(){
      if (!status) return;
      status.hidden = true;
      status.textContent = "";
      status.className = "sb-status";
    }

    function showStatus(msg, ok=false){
      if (!status) return;
      status.hidden = false;
      status.className = "sb-status " + (ok ? "ok" : "err");
      status.textContent = msg;
    }

    function openModal(prefillEmail){
      lastFocus = document.activeElement;

      hideStatus();
      if (confirmBox) confirmBox.hidden = true;
      if (maxedBox) maxedBox.hidden = true;
      if (formView) formView.hidden = false;

      if (prefillEmail) emailEl.value = String(prefillEmail).trim().toLowerCase();

      brandEl.value = "";
      modelEl.value = "";
      priceEl.value = "";

      setGender("");

      backdrop.classList.add("open");
      backdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      setTimeout(() => (emailEl.value ? brandEl.focus() : emailEl.focus()), 0);
    }

    function closeModal(){
      closeSuggestions();
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
    }

    openers.forEach(el => {
      el.addEventListener("click", (e) => {
        e.preventDefault();
        const emailFromQS = new URLSearchParams(location.search).get("email");
        openModal(emailFromQS);
      });
    });

    closeBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });
    document.addEventListener("keydown", (e) => {
      if (backdrop.classList.contains("open") && e.key === "Escape") closeModal();
    });

    if (maxedClose) maxedClose.addEventListener("click", closeModal);

    function setGender(g){
      selectedGender = String(g || "");
      const opts = genderWrap.querySelectorAll(".sb-gender-option");
      opts.forEach(o => {
        const on = (o.getAttribute("data-g") || "") === selectedGender;
        o.classList.toggle("active", on);
        o.setAttribute("aria-checked", on ? "true" : "false");
      });
    }

    genderWrap.addEventListener("click", (e) => {
      const opt = e.target.closest(".sb-gender-option");
      if (!opt) return;
      const g = opt.getAttribute("data-g") || "";
      setGender(g);
    });

    genderWrap.addEventListener("keydown", (e) => {
      const opt = e.target.closest(".sb-gender-option");
      if (!opt) return;
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const g = opt.getAttribute("data-g") || "";
        setGender(g);
      }
    });

    document.addEventListener("click", (e) => {
      if (!backdrop.classList.contains("open")) return;
      const c = e.target.closest("[data-clear]");
      if (!c) return;

      e.preventDefault();
      const sel = c.getAttribute("data-clear");
      const input = sel ? document.querySelector(sel) : null;
      if (!input) return;

      input.value = "";
      hideStatus();
      closeSuggestions(input === brandEl ? "brand" : input === modelEl ? "model" : null);
      input.focus();
    });

    function normalizeWholeDollars(v){
      let s = String(v || "").replace(/[^0-9]/g, "");
      s = s.replace(/^0+(?=\d)/, "");
      if (!s) s = "";
      return s.slice(0, 4);
    }

    priceEl.addEventListener("input", () => {
      priceEl.value = normalizeWholeDollars(priceEl.value);
    });

    priceEl.addEventListener("keypress", (e) => {
      if (e.key && !/[0-9]/.test(e.key)) e.preventDefault();
    });

    const S = { open: null, items: [], idx: -1 };
    const squash = s => String(s||"").toLowerCase().replace(/[^a-z0-9]/g, "");

    function score(cand, q){
      const c = String(cand||"");
      const cl = c.toLowerCase();
      q = String(q||"").trim().toLowerCase();
      if (!q) return 0;
      const cs = squash(c), qs = squash(q);
      let s = 0;
      if (cl.startsWith(q)) s += 120;
      if (cl.includes(q)) s += 80;
      if (qs.length >= 3 && cs.includes(qs)) s += 110;
      s -= Math.min(c.length, 30) * 0.25;
      return s;
    }

    function topMatches(list, typed, limit=10){
      const q = String(typed||"").trim();
      if (!q) return [];
      return list
        .map(v => ({ v, s: score(v, q) }))
        .filter(x => x.s > 0)
        .sort((a,b) => b.s - a.s)
        .slice(0, limit)
        .map(x => x.v);
    }

    function renderSug(box, items, which, onPick){
      box.innerHTML = "";
      if (!items.length){
        box.hidden = true;
        if (S.open === which) S.open = null;
        return;
      }
      S.open = which; S.items = items; S.idx = -1;
      items.forEach((v) => {
        const d = document.createElement("div");
        d.className = "item";
        d.textContent = v;
        d.addEventListener("mousedown", (e) => { e.preventDefault(); onPick(v); });
        box.appendChild(d);
      });
      box.hidden = false;
    }

    function closeSuggestions(which){
      if (!which || which === "brand"){ brandSug.hidden = true; brandSug.innerHTML = ""; }
      if (!which || which === "model"){ modelSug.hidden = true; modelSug.innerHTML = ""; }
      if (!which){ S.open = null; S.items = []; S.idx = -1; }
      else if (S.open === which){ S.open = null; S.items = []; S.idx = -1; }
    }

    function resolveBrandKey(input){
      const n = String(input||"").trim().toLowerCase();
      return brands.find(b => String(b).trim().toLowerCase() === n) || "";
    }

    function toggleClear(input){
      const wrap = input.closest(".sb-input-wrap");
      if (!wrap) return;
      const c = wrap.querySelector(".sb-clear");
      if (!c) return;
      c.style.display = input.value.trim() ? "flex" : "none";
    }

    brandEl.addEventListener("input", () => {
      const t = brandEl.value.trim();
      toggleClear(brandEl);
      if (!t) return closeSuggestions("brand");
      renderSug(brandSug, topMatches(brands, t, 12), "brand", (v) => {
        brandEl.value = v; toggleClear(brandEl);
        closeSuggestions("brand");
        setTimeout(() => modelEl.focus(), 0);
      });
    });

    modelEl.addEventListener("input", () => {
      const t = modelEl.value.trim();
      toggleClear(modelEl);
      if (!t) return closeSuggestions("model");
      const bk = resolveBrandKey(brandEl.value);
      const pool = (bk && Array.isArray(brandModels[bk])) ? brandModels[bk] : allModels;
      renderSug(modelSug, topMatches(pool, t, 12), "model", (v) => {
        modelEl.value = v; toggleClear(modelEl);
        closeSuggestions("model");
        setTimeout(() => priceEl.focus(), 0);
      });
    });

    brandEl.addEventListener("focus", () => toggleClear(brandEl));
    modelEl.addEventListener("focus", () => toggleClear(modelEl));

    function sanitize(str){
      return String(str||"")
        .replace(/[<>'"]/g, "")
        .replace(/script/gi, "")
        .replace(/javascript:/gi, "")
        .replace(/on\w+=/gi, "")
        .trim()
        .slice(0, 100);
    }

    function esc(s){
      return String(s||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    async function postJson(url, payload){
      const res = await fetch(url, {
        method: "POST",
        cache: "no-store",
        headers: { "Content-Type": "application/json", "Cache-Control": "no-cache" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const code = data && data.code ? String(data.code) : "";
        const msg = data && data.error ? String(data.error) : `HTTP ${res.status}: Failed to create alert`;
        const err = new Error(msg);
        err.code = code;
        throw err;
      }
      return data;
    }

    function showSuccess(brand, model, gender, price){
      const genderText = gender === "mens" ? "Men’s" : "Women’s";
      confirmDetails.innerHTML =
        `<div><strong>Shoe:</strong> ${esc(brand)} ${esc(model)}</div>
         <div><strong>Gender:</strong> ${esc(genderText)}</div>
         <div><strong>Target Price:</strong> $${esc(String(price))} or less</div>`;

      hideStatus();
      closeSuggestions();
      if (formView) formView.hidden = true;
      if (maxedBox) maxedBox.hidden = true;
      if (confirmBox) confirmBox.hidden = false;

      brandEl.value = "";
      modelEl.value = "";
      priceEl.value = "";
      toggleClear(brandEl);
      toggleClear(modelEl);
    }

    function showMaxedOut(){
      hideStatus();
      closeSuggestions();
      if (formView) formView.hidden = true;
      if (confirmBox) confirmBox.hidden = true;
      if (maxedBox) maxedBox.hidden = false;

      brandEl.value = "";
      modelEl.value = "";
      priceEl.value = "";
      toggleClear(brandEl);
      toggleClear(modelEl);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (busy) return;

      hideStatus();
      if (confirmBox) confirmBox.hidden = true;
      if (maxedBox) maxedBox.hidden = true;

      const email = sanitize(emailEl.value).toLowerCase();
      const brand = sanitize(brandEl.value);
      const model = sanitize(modelEl.value);
      const targetPrice = parseInt(String(priceEl.value || ""), 10);
      const gender = selectedGender;

      if (!email || !email.includes("@")) return showStatus("Please enter a valid email address.");
      if (!brand) return showStatus("Please enter a shoe brand.");
      if (!model) return showStatus("Please enter a shoe model.");
      if (!gender) return showStatus("Select a gender.");
      if (!targetPrice || targetPrice <= 0) return showStatus("Please enter a valid target price (whole dollars).");

      setBusy(true);
      try {
        await postJson(API_ALERTS, { email, brand, model, targetPrice, gender });
        showSuccess(brand, model, gender, targetPrice);
      } catch (err) {
        const msg = (err && err.message) ? String(err.message) : "Failed to set alert.";
        const code = err && err.code ? String(err.code) : "";
        const looksMax =
          code.toUpperCase().includes("MAX") ||
          msg.toLowerCase().includes("max") ||
          msg.toLowerCase().includes("limit");

        if (looksMax) showMaxedOut();
        else showStatus(msg);
      } finally {
        setBusy(false);
      }
    });

    if (setAnother) {
      setAnother.addEventListener("click", () => {
        if (confirmBox) confirmBox.hidden = true;
        if (maxedBox) maxedBox.hidden = true;
        if (formView) formView.hidden = false;
        hideStatus();

        brandEl.value = "";
        modelEl.value = "";
        priceEl.value = "";
        toggleClear(brandEl);
        toggleClear(modelEl);
        closeSuggestions();

        setTimeout(() => brandEl.focus(), 0);
      });
    }
  })();
  </script>

</body>
</html>
