<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                 img-src * data: https:;
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self' https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com;
                 font-src 'self';
                 frame-src 'none';">
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS split -->
  <link rel="stylesheet" href="/pages/index.css?v=82">

  <!--
    IMPORTANT:
    Set this at deploy time to avoid hardcoding the blob store base.
    Example value:
      https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com
  -->
  <meta name="shoebeagle-blob-base" content="__BLOB_BASE_URL__">
</head>

<body>
  <div class="app">
    <img class="mobile-top-banner" src="/images/logo_heading.svg" alt="">

    <!-- TOP AREA: inputs left, logo right -->
    <div class="topbar">
      <div class="top-left">
        <form id="search-form" method="POST" autocomplete="off">

       <!-- BRAND ROW: input + links toggle button -->
<div class="row">
  <div class="input-wrapper">
    <!-- permanent magnifying glass (NOT part of the input text) -->
    <img class="input-icon" src="/images/mg.svg" alt="" aria-hidden="true">

    <!-- placeholder no longer includes ðŸ” so caret starts after icon -->
    <input id="brand" type="text" placeholder="Brand..." autocomplete="off"/>

    <button type="button" class="input-clear" aria-label="Clear brand">&times;</button>
    <div id="brandSuggestions" class="suggestions"></div>
  </div>

  <div class="button-wrapper">
    <!-- This is now ONLY a links toggle button -->
    <button id="menuBtn"
            type="button"
            class="btn-eq"
            aria-label="Links"
            aria-expanded="false"
            aria-controls="linksRibbon">
      <img src="/images/menu.svg" class="btn-icon" alt="Links">
    </button>
  </div>
</div>

<!-- MODEL ROW: input + fetch -->
<div class="row">
  <div class="input-wrapper">
    <!-- permanent magnifying glass (NOT part of the input text) -->
    <img class="input-icon" src="/images/mg.svg" alt="" aria-hidden="true">

    <!-- placeholder no longer includes ðŸ” so caret starts after icon -->
    <input id="model" type="text" placeholder="Model..." autocomplete="off"/>

    <button type="button" class="input-clear" aria-label="Clear model">&times;</button>
    <div id="modelSuggestions" class="suggestions"></div>
  </div>

  <div class="button-wrapper">
    <button id="fetchBtn" type="submit" class="btn-eq" aria-label="Fetch">
      <img src="/images/fetch.svg" class="btn-icon" alt="Fetch">
    </button>
  </div>
</div>


        </form>
      </div>

      <!-- LOGO RIGHT -->
      <div class="top-right">
        <img
          src="/images/logo.svg"
          class="brand-logo"
          alt="Shoe Beagle Logo"
          id="logoLink"
        >
      </div>
    </div>

    <!-- Links ribbon (hidden by default; toggled by the button above) -->
<div id="linksRibbon" class="links-ribbon" style="display:none;">
  <div class="links-ribbon-inner">

    <!-- far left -->
    <a href="/signin" class="links-ribbon-signin">Sign In</a>

    <!-- centered links -->
    <div class="links-ribbon-links">
      <a href="/pages/myalerts.html">My Alerts</a>
      <a href="/pages/setalert.html">Set Alert</a>
      <a href="#" aria-disabled="true" tabindex="0">Favorites</a>
    </div>

    <!-- far right close -->
    <button type="button" class="chip-close" aria-label="Close links">&times;</button>

  </div>
</div>


    <div id="mainContent">

      <!-- Filters should be ABOVE the status line -->
      <div class="filters" id="filters" style="display:none;">
        <div class="filter-row">
          <div class="filter-label">Gender:</div>
          <div class="chip-group" id="genderChips">
            <button type="button" class="chip active" data-gender="" aria-label="Filter off">&times;</button>
            <button type="button" class="chip" data-gender="mens" aria-label="Men's">M</button>
            <button type="button" class="chip" data-gender="womens" aria-label="Women's">W</button>
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-label">Shoe type:</div>
          <div class="chip-group" id="typeChips">
            <button type="button" class="chip active" data-type="" aria-label="Filter off">&times;</button>
            <button type="button" class="chip" data-type="road" aria-label="Road">R</button>
            <button type="button" class="chip" data-type="trail" aria-label="Trail">T</button>
            <button type="button" class="chip" data-type="track" aria-label="Spikes">S</button>
          </div>
        </div>
      </div>

      <!-- One line that is ALWAYS visible -->
      <div class="status-message" id="statusMessage">
        Martyâ€™s Daily Deals
      </div>

      <!-- Daily deals block -->
      <div class="daily-deals" id="dailyDeals">
        <div class="shoe-grid" id="dailyDealsGrid"></div>
      </div>

      <div class="shoe-grid" id="results"></div>

      <!-- âœ… Mobile portrait: load more (appends next 12) -->
      <div class="load-more-wrap" id="loadMoreWrap" style="display:none;">
        <button id="loadMoreBtn" class="load-more-btn" type="button">Load more</button>
      </div>

      <!-- âœ… Desktop/tablet: pager (prev/next) -->
      <div class="pager">
        <button id="prevPage" class="pager-btn" aria-label="Previous page">â—€</button>
        <div id="pageLabel" class="page-label">1 / 1</div>
        <button id="nextPage" class="pager-btn" aria-label="Next page">â–¶</button>
      </div>

      <p class="disclaimer">
        Shoe Beagle may earn commissions through our affiliate program at no cost to you.
        We do not sell products directly and are not responsible for changes in price, availability,
        or shipping terms on retailer sites.
      </p>

    </div>

    <div class="footer">
      <div class="footer-links">
        <a href="/pages/about.html">About</a> |
        <a href="/pages/contact.html">Contact</a> |
        <a href="/pages/privacy.html">Privacy</a> |
        <a href="/pages/terms.html">Terms</a>
      </div>

      <div class="footer-copy">
        Â© <span id="footerYear"></span> Shoe Beagle. All rights reserved.
      </div>
    </div>
<button class="to-top" id="toTopBtn" type="button" aria-label="Back to top">â†‘</button>
  </div>

  <script src="./brandModels.js"></script>

  <script>
  (() => {
    const form = document.getElementById("search-form");

    const statusMessageEl = document.getElementById("statusMessage");
    const resultsEl = document.getElementById("results");
    const dailyDeals = document.getElementById("dailyDeals");
    const dailyDealsGrid = document.getElementById("dailyDealsGrid");
    const fetchBtn = document.getElementById("fetchBtn");
    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");
    const logoLink = document.getElementById("logoLink");
    const footerYear = document.getElementById("footerYear");
    const appEl = document.querySelector(".app");
    
    // Links toggle button + ribbon
    const menuBtn = document.getElementById("menuBtn");
    const linksRibbon = document.getElementById("linksRibbon");
const linksRibbonClose = linksRibbon?.querySelector(".chip-close");

    const filtersEl = document.getElementById("filters");
    const genderChips = document.getElementById("genderChips");
    const typeChips = document.getElementById("typeChips");

    const PAGE_SIZE = 12;
    let pageIndex = 0;

    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageLabelEl = document.getElementById("pageLabel");

    // âœ… Load more elements
    const loadMoreWrap = document.getElementById("loadMoreWrap");
    const loadMoreBtn = document.getElementById("loadMoreBtn");
const toTopBtn = document.getElementById("toTopBtn");
    function isMobilePortrait(){
        return window.matchMedia("(max-width: 560px) and (orientation: portrait)").matches;
    }

    function runPagerTransitionThen(fn){
      if (isMobilePortrait()) { fn(); return; }
      resultsEl.classList.add("is-switching");
      setTimeout(() => {
        fn();
        requestAnimationFrame(() => {
          resultsEl.classList.remove("is-switching");
        });
      }, 160);
    }

    let currentSearch = { brand: "", model: "" };
    let lastSearchResults = [];
    let selectedGender = "";
    let selectedShoeType = "";

    if (footerYear) footerYear.textContent = new Date().getFullYear();
    if (logoLink) logoLink.addEventListener("click", () => location.reload());

    // --- Links ribbon toggle ---
    function isRibbonOpen(){
      return !!(linksRibbon && linksRibbon.style.display !== "none");
    }

    function openRibbon(){
      if (!linksRibbon) return;
      linksRibbon.style.display = "block";
      if (menuBtn) menuBtn.setAttribute("aria-expanded", "true");
    }

    function closeRibbon(){
      if (!linksRibbon) return;
      linksRibbon.style.display = "none";
      if (menuBtn) menuBtn.setAttribute("aria-expanded", "false");
    }

    function toggleRibbon(){
      if (!linksRibbon) return;
      if (isRibbonOpen()) closeRibbon();
      else openRibbon();
    }

    if (menuBtn) {
      menuBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleRibbon();
      });
    }

    if (linksRibbonClose) {
      linksRibbonClose.addEventListener("click", (e) => {
        e.preventDefault();
        closeRibbon();
      });
    }

    document.addEventListener("click", (e) => {
      if (!linksRibbon || linksRibbon.style.display === "none") return;
      const clickedInsideRibbon = linksRibbon.contains(e.target);
      const clickedButton = menuBtn && menuBtn.contains(e.target);
      if (!clickedInsideRibbon && !clickedButton) closeRibbon();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeRibbon();
    });

    if (linksRibbon) {
      linksRibbon.addEventListener("click", (e) => {
        const a = e.target.closest("a");
        if (a) closeRibbon();
      });
    }

    // make sure brandModels always exists
    const brandModels = window.brandModels || {};

    // --- Helpers ---
    function normalizeStr(s) { return String(s || "").trim().toLowerCase(); }
    function normalizeEnum(s) { return String(s || "").trim().toLowerCase(); }

    function sanitizeInput(str) {
      return String(str || "")
        .replace(/[<>'"]/g, '')
        .replace(/script/gi, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .trim()
        .slice(0, 100);
    }

    function updateFetchReady() {
      const hasAny = !!((brandInput && brandInput.value.trim()) || (modelInput && modelInput.value.trim()));
      if (fetchBtn) fetchBtn.disabled = !hasAny;
    }
    updateFetchReady();

    document.querySelectorAll('.input-clear').forEach((clearBtn, index) => {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const input = clearBtn.previousElementSibling;
        if (input && input.tagName === 'INPUT') {
          input.value = '';
          input.focus();
          if (index === 0) closeSuggestions("brand");
          else closeSuggestions("model");
          updateFetchReady();
        }
      });
    });

    function isValidRetailerUrl(url) {
      if (!url || url === '#') return false;
      try {
        const u = new URL(url);
        return u.protocol === "https:" || u.protocol === "http:";
      } catch {
        return false;
      }
    }

    // --- Blob base ---
    function getBlobBase() {
      const meta = document.querySelector('meta[name="shoebeagle-blob-base"]');
      const fromMeta = meta ? String(meta.getAttribute("content") || "").trim() : "";
      const looksLikePlaceholder = fromMeta.includes("__BLOB_BASE_URL__");
      if (fromMeta && !looksLikePlaceholder) return fromMeta.replace(/\/+$/, "");
      return "https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com";
    }

    function blobUrl(path) {
      const base = getBlobBase();
      const cleanPath = String(path || "").replace(/^\/+/, "");
      return base.replace(/\/+$/, "") + "/" + cleanPath;
    }

    function withCacheBust(url) {
      const u = new URL(url, window.location.origin);
      u.searchParams.set("cb", String(Date.now()));
      return u.toString();
    }

    function getDiscountInfo(item) {
      const current = Number(item.salePrice);
      const original = Number(item.originalPrice);

      if (Number.isFinite(current) && Number.isFinite(original) && original > 0 && current < original) {
        const pct = Math.round(((original - current) / original) * 100);
        return { hasDiscount: true, current: current.toFixed(2), original: original.toFixed(2), percent: pct };
      }

      const pct2 = Number(item.discountPercent);
      if (Number.isFinite(current) && Number.isFinite(pct2) && pct2 > 0 && pct2 < 100) {
        const origGuess = current / (1 - pct2 / 100);
        if (Number.isFinite(origGuess) && origGuess > current) {
          return { hasDiscount: true, current: current.toFixed(2), original: origGuess.toFixed(2), percent: Math.round(pct2) };
        }
        return { hasDiscount: true, current: current.toFixed(2), original: "", percent: Math.round(pct2) };
      }

      return { hasDiscount: false };
    }

    const brands = Object.keys(brandModels).sort((a,b) => a.localeCompare(b));

    function squashStr(s) { return String(s || "").toLowerCase().replace(/[^a-z0-9]/g, ""); }

    function scoreSuggestion(candidate, query) {
      const c = String(candidate || "");
      const cl = c.toLowerCase();
      const q = String(query || "").trim().toLowerCase();
      if (!q) return 0;

      const cSquash = squashStr(c);
      const qSquash = squashStr(q);

      let score = 0;
      if (cl.startsWith(q)) score += 120;
      if (cl.includes(q)) score += 80;
      if (qSquash.length >= 3 && cSquash.includes(qSquash)) score += 110;

      const qParts = q.split(/\s+/).filter(Boolean);
      if (qParts.length >= 2) {
        const cParts = cl.split(/\s+/);
        let tokenHits = 0;
        for (const qp of qParts) {
          if (cParts.some(cp => cp.startsWith(qp))) tokenHits++;
        }
        score += tokenHits * 25;
      }

      score -= Math.min(c.length, 30) * 0.25;
      return score;
    }

    function levenshtein(a, b) {
      a = String(a || "");
      b = String(b || "");
      const m = a.length, n = b.length;
      if (!m) return n;
      if (!n) return m;

      const dp = new Array(n + 1);
      for (let j = 0; j <= n; j++) dp[j] = j;

      for (let i = 1; i <= m; i++) {
        let prev = dp[0];
        dp[0] = i;
        for (let j = 1; j <= n; j++) {
          const temp = dp[j];
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[j] = Math.min(dp[j] + 1, dp[j - 1] + 1, prev + cost);
          prev = temp;
        }
      }
      return dp[n];
    }

    function resolveClosestBrand(input) {
      const raw = String(input || "").trim();
      if (!raw) return "";

      const exact = brands.find(b => normalizeStr(b) === normalizeStr(raw));
      if (exact) return exact;

      const q = squashStr(raw);
      if (!q) return raw;

      let best = null;
      let bestDist = Infinity;

      for (const b of brands) {
        const bs = squashStr(b);
        const d = levenshtein(q, bs);
        if (d < bestDist) {
          bestDist = d;
          best = b;
        }
      }

      const len = q.length;
      const threshold = len <= 4 ? 1 : (len <= 7 ? 2 : 3);
      return (best != null && bestDist <= threshold) ? best : raw;
    }

    function filterSuggestions(list, typed, limit = 10) {
      const q = String(typed || "").trim();
      if (!q) return [];

      const qLower = q.toLowerCase();
      const starts = list.filter(v => String(v).toLowerCase().startsWith(qLower));
      if (starts.length) {
        const ranked = starts
          .map(v => ({ v, s: scoreSuggestion(v, q) }))
          .sort((a, b) => b.s - a.s)
          .slice(0, limit)
          .map(x => x.v);
        return Array.from(new Set(ranked));
      }

      const scored = list
        .map(v => ({ v, s: scoreSuggestion(v, q) }))
        .filter(x => x.s > 0)
        .sort((a, b) => b.s - a.s)
        .slice(0, limit)
        .map(x => x.v);

      return Array.from(new Set(scored));
    }

    const allModels = (() => {
      const flat = [];
      for (const b of Object.keys(brandModels)) {
        const arr = brandModels[b];
        if (Array.isArray(arr)) flat.push(...arr);
      }
      return Array.from(new Set(flat)).sort((a, b) => a.localeCompare(b));
    })();

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }
    function resolveBrand() { return resolveBrandKey(brandInput.value.trim()); }

    const suggestionState = { openFor: null, items: [], activeIndex: -1 };

    function closeSuggestions(which) {
      if (!which || which === "brand") {
        brandSuggestions.style.display = "none";
        brandSuggestions.innerHTML = "";
      }
      if (!which || which === "model") {
        modelSuggestions.style.display = "none";
        modelSuggestions.innerHTML = "";
      }

      if (!which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      } else if (suggestionState.openFor === which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      }
    }

    function renderSuggestions(container, items, which, onPick) {
      container.innerHTML = "";

      if (!items.length) {
        container.style.display = "none";
        if (suggestionState.openFor === which) {
          suggestionState.openFor = null;
          suggestionState.items = [];
          suggestionState.activeIndex = -1;
        }
        return;
      }

      suggestionState.openFor = which;
      suggestionState.items = items.slice();
      suggestionState.activeIndex = -1;

      items.forEach((value, idx) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.dataset.index = String(idx);

        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onPick(value);
        });

        container.appendChild(div);
      });

      container.style.display = "block";
    }

    function highlightActive(container) {
      const children = Array.from(container.querySelectorAll(".suggestion-item"));
      children.forEach(el => el.classList.remove("active"));

      if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < children.length) {
        const active = children[suggestionState.activeIndex];
        active.classList.add("active");

        const box = container;
        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;
        if (top < box.scrollTop) box.scrollTop = top;
        else if (bottom > box.scrollTop + box.clientHeight) box.scrollTop = bottom - box.clientHeight;
      }
    }

    function handleSuggestionKeys(e, which, container, onPick) {
      if (suggestionState.openFor !== which) return;

      const max = suggestionState.items.length;
      if (!max) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex + 1) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex - 1 + max) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "Enter") {
        if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < max) {
          e.preventDefault();
          const value = suggestionState.items[suggestionState.activeIndex];
          onPick(value);
        }
        return;
      }

      if (e.key === "Escape") {
        e.preventDefault();
        closeSuggestions(which);
        return;
      }
    }

    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();
      if (typed.length < 1) {
        closeSuggestions("brand");
        updateFetchReady();
        return;
      }

      const matches = filterSuggestions(brands, typed, 12);
      renderSuggestions(brandSuggestions, matches, "brand", (value) => {
        brandInput.value = value;
        closeSuggestions("brand");
        setTimeout(() => modelInput.focus(), 0);
        updateFetchReady();
      });

      updateFetchReady();
    });

    brandInput.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "brand", brandSuggestions, (value) => {
        brandInput.value = value;
        closeSuggestions("brand");
        setTimeout(() => modelInput.focus(), 0);
        updateFetchReady();
      });
    });

    brandInput.addEventListener("blur", () => setTimeout(() => closeSuggestions("brand"), 140));

    modelInput.addEventListener("input", () => {
      const text = modelInput.value.trim();
      if (text.length < 1) {
        closeSuggestions("model");
        updateFetchReady();
        return;
      }

      const brandKey = resolveBrand();
      const pool = (brandKey && Array.isArray(brandModels[brandKey])) ? brandModels[brandKey] : allModels;

      const matches = filterSuggestions(pool, text, 12);
      renderSuggestions(modelSuggestions, matches, "model", (value) => {
        modelInput.value = value;
        closeSuggestions("model");
        setTimeout(() => fetchBtn.focus(), 0);
        updateFetchReady();
      });

      updateFetchReady();
    });

    modelInput.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "model", modelSuggestions, (value) => {
        modelInput.value = value;
        closeSuggestions("model");
        setTimeout(() => fetchBtn.focus(), 0);
        updateFetchReady();
      });
    });

    modelInput.addEventListener("blur", () => setTimeout(() => closeSuggestions("model"), 140));

    brandInput.addEventListener("click", () => brandInput.select());
    modelInput.addEventListener("click", () => modelInput.select());

    document.addEventListener("click", (e) => {
      const insideBrand = brandSuggestions.contains(e.target) || brandInput.contains(e.target);
      const insideModel = modelSuggestions.contains(e.target) || modelInput.contains(e.target);
      if (!insideBrand) closeSuggestions("brand");
      if (!insideModel) closeSuggestions("model");
    });

    function setActiveChip(groupEl, activeBtn) {
      if (!groupEl) return;
      groupEl.querySelectorAll(".chip").forEach(btn => btn.classList.remove("active"));
      if (activeBtn) activeBtn.classList.add("active");
    }

    function applyFilters(items) {
      const g = normalizeEnum(selectedGender);
      const t = normalizeEnum(selectedShoeType);

      return (items || []).filter(item => {
        const itemGender = normalizeEnum(item.gender);
        const itemType = normalizeEnum(item.shoeType);

        const genderOk = !g || itemGender === g || itemGender === "unisex";
        const typeOk = !t || itemType === t;

        return genderOk && typeOk;
      });
    }

    function totalPagesCount(total){
      return Math.max(1, Math.ceil((Number(total) || 0) / PAGE_SIZE));
    }

    // âœ… One place to control pager vs load-more
    function updateNavUI(totalFiltered){
      const pager = document.querySelector(".pager");

      if (isMobilePortrait()){
        // Hide desktop pager on mobile portrait
        if (pager) pager.style.display = "none";

        const hasMore = ((pageIndex + 1) * PAGE_SIZE) < (Number(totalFiltered) || 0);
        if (loadMoreWrap) loadMoreWrap.style.display = hasMore ? "flex" : "none";
        return;
      }

      // Desktop/tablet: show pager if > 1 page
      if (loadMoreWrap) loadMoreWrap.style.display = "none";

      const pages = totalPagesCount(totalFiltered);
      const current = Math.min(pageIndex + 1, pages);

      if (pageLabelEl) pageLabelEl.textContent = `${current} of ${pages}`;
      if (prevPageBtn) prevPageBtn.disabled = pageIndex <= 0;
      if (nextPageBtn) nextPageBtn.disabled = (pageIndex + 1) >= pages;

      if (pager) pager.style.display = (pages > 1) ? "flex" : "none";
    }

    // âœ… render results with optional append (for mobile â€œLoad moreâ€)
    function renderFilteredResults({ resetPage = true, append = false } = {}) {
      const filtered = applyFilters(lastSearchResults);

      if (resetPage) pageIndex = 0;

      const start = pageIndex * PAGE_SIZE;
      const slice = filtered.slice(start, start + PAGE_SIZE);

      if (!append) resultsEl.innerHTML = "";
      slice.forEach(item => resultsEl.appendChild(createDealCard(item)));

      const displayQuery =
        [currentSearch.brand, currentSearch.model].filter(Boolean).join(" ").trim() || "all shoes";

      if (!filtered.length) {
        statusMessageEl.textContent = `No results match your filters for ${displayQuery}.`;
        updateNavUI(0);
        return;
      }

      statusMessageEl.textContent =
        `We found ${filtered.length} deal${filtered.length === 1 ? "" : "s"} on ${displayQuery} shoes.`;

      updateNavUI(filtered.length);
    }

    // âœ… Mobile Load More handler
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener("click", () => {
        const filtered = applyFilters(lastSearchResults);
        const total = filtered.length;

        const hasMore = ((pageIndex + 1) * PAGE_SIZE) < total;
        if (!hasMore) return;

        pageIndex++;
        // append the next page
        renderFilteredResults({ resetPage: false, append: true });
      });
    }

    // Desktop pager buttons (unchanged behavior)
    if (prevPageBtn) {
      prevPageBtn.addEventListener("click", () => {
        const filtered = applyFilters(lastSearchResults);
        if (pageIndex <= 0) return;

        runPagerTransitionThen(() => {
          pageIndex--;
          renderFilteredResults({ resetPage: false, append: false });
          resultsEl.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });
    }

    if (nextPageBtn) {
      nextPageBtn.addEventListener("click", () => {
        const filtered = applyFilters(lastSearchResults);
        const pages = totalPagesCount(filtered.length);
        if (pageIndex >= pages - 1) return;

        runPagerTransitionThen(() => {
          pageIndex++;
          renderFilteredResults({ resetPage: false, append: false });
          resultsEl.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });
    }

    if (genderChips) {
      genderChips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if (!btn) return;
        selectedGender = normalizeEnum(btn.dataset.gender);
        setActiveChip(genderChips, btn);
        renderFilteredResults({ resetPage: true, append: false });
      });
    }

    if (typeChips) {
      typeChips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if (!btn) return;
        selectedShoeType = normalizeEnum(btn.dataset.type);
        setActiveChip(typeChips, btn);
        renderFilteredResults({ resetPage: true, append: false });
      });
    }

    function createDealCard(item) {
      const discount = getDiscountInfo(item);

      const card = document.createElement("div");
      card.className = "card";

      const link = document.createElement("a");
      link.className = "card-link";

      const listingUrl = item.listingURL;
      const safeLink = isValidRetailerUrl(listingUrl) ? listingUrl : "#";
      if (safeLink === "#" && listingUrl) console.warn("Blocked untrusted retailer URL:", listingUrl);

      link.href = safeLink;
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      const imgWrapper = document.createElement("div");
      imgWrapper.className = "card-image-wrapper";

      const img = document.createElement("img");
      img.src = item.imageURL ? item.imageURL : "https://placehold.co/600x400?text=Running+Shoe";
      img.alt = (item.brand && item.model) ? `${item.brand} ${item.model}` : (item.model || item.brand || "Running shoe deal");
      imgWrapper.appendChild(img);

      if (discount.hasDiscount) {
        const badge = document.createElement("div");
        badge.className = "discount-badge";
        badge.textContent = `${discount.percent}% OFF`;
        imgWrapper.appendChild(badge);
      }

      const gRaw = normalizeEnum(item.gender);
      const tRaw = normalizeEnum(item.shoeType);

      const g = (gRaw && gRaw !== "unknown") ? gRaw : "";
      const t = (tRaw && tRaw !== "unknown") ? tRaw : "";

      const tagWrap = document.createElement("div");
      tagWrap.className = "card-tags";

      let hasAnyTag = false;

      if (g) {
        const genderTag = document.createElement("span");
        genderTag.className = "card-tag";
        genderTag.textContent = g === "mens" ? "Mens" : g === "womens" ? "Womens" : "Unisex";
        tagWrap.appendChild(genderTag);
        hasAnyTag = true;
      }

      if (t) {
        const typeTag = document.createElement("span");
        typeTag.className = "card-tag";
        typeTag.textContent =
          t === "road" ? "Road" :
          t === "trail" ? "Trail" :
          t === "track" ? "Spikes" : (item.shoeType || "");
        tagWrap.appendChild(typeTag);
        hasAnyTag = true;
      }

      if (hasAnyTag) imgWrapper.appendChild(tagWrap);

      link.appendChild(imgWrapper);

      const contentDiv = document.createElement("div");
      contentDiv.className = "card-content";

      const titleDiv = document.createElement("div");
      titleDiv.className = "card-title";

      const brand = (item.brand || "").trim();
      const model = (item.model || "").trim();

      if (brand && model) {
        titleDiv.innerHTML = `<strong style="text-transform: uppercase;">${brand}</strong><br>${model}`;
      } else if (brand) {
        titleDiv.innerHTML = `<strong style="text-transform: uppercase;">${brand}</strong>`;
      } else if (model) {
        titleDiv.textContent = model;
      } else {
        titleDiv.textContent = "Deal";
      }

      contentDiv.appendChild(titleDiv);

      if (item.store) {
        const storeDiv = document.createElement("div");
        storeDiv.className = "card-store";
        storeDiv.textContent = item.store;
        contentDiv.appendChild(storeDiv);
      }

      const priceRow = document.createElement("div");
      priceRow.className = "card-price-row";

      const priceSpan = document.createElement("span");
      priceSpan.className = "price";

      const currentPrice = Number(item.salePrice);
      if (Number.isFinite(currentPrice)) priceSpan.textContent = `$${currentPrice.toFixed(2)}`;
      else priceSpan.textContent = item.salePrice != null ? String(item.salePrice) : "â€”";

      priceRow.appendChild(priceSpan);

      if (discount.hasDiscount && discount.original) {
        const origSpan = document.createElement("span");
        origSpan.className = "card-original-price";
        origSpan.textContent = `$${discount.original}`;
        priceRow.appendChild(origSpan);
      }

      contentDiv.appendChild(priceRow);
      link.appendChild(contentDiv);

      card.appendChild(link);
      return card;
    }

    // --- Daily deals ---
    async function loadDailyDeals() {
      try {
        const url = withCacheBust(blobUrl("twelve_daily_deals.json"));
        const res = await fetch(url);

        if (!res.ok) {
          console.error("Failed to fetch daily deals:", res.status, res.statusText);
          if (dailyDeals) dailyDeals.style.display = "none";
          return;
        }

        const data = await res.json();
        const deals = Array.isArray(data.deals) ? data.deals : [];

        if (dailyDealsGrid) dailyDealsGrid.innerHTML = "";

        if (!deals.length) {
          if (dailyDeals) dailyDeals.style.display = "none";
          return;
        }

        deals.forEach(item => dailyDealsGrid.appendChild(createDealCard(item)));

        if (dailyDeals) dailyDeals.style.display = "block";
      } catch (err) {
        console.error("Error loading daily deals:", err);
        if (dailyDeals) dailyDeals.style.display = "none";
      }
    }

    loadDailyDeals();
// --- Back to top (mobile portrait only) ---
function updateToTopVisibility(){
  if (!toTopBtn) return;

  if (!isMobilePortrait()){
    toTopBtn.classList.remove("is-visible");
    return;
  }

  if (window.scrollY > 250)
    toTopBtn.classList.add("is-visible");
  else
    toTopBtn.classList.remove("is-visible");
}

window.addEventListener("scroll", updateToTopVisibility, { passive: true });
window.addEventListener("resize", updateToTopVisibility);
updateToTopVisibility();

if (toTopBtn){
  toTopBtn.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
}
    // --- Mobile portrait: expand inputs on focus, shrink on submit/return ---
function expandInputs(){
  if (!appEl) return;
  if (!isMobilePortrait()) return;
  appEl.classList.add("inputs-expanded");
}

function shrinkInputs(){
  if (!appEl) return;
  appEl.classList.remove("inputs-expanded");
}

// Expand when either input is focused/tapped
if (brandInput) brandInput.addEventListener("focus", expandInputs);
if (modelInput) modelInput.addEventListener("focus", expandInputs);

// Optional: shrink if user taps away (nice UX)
document.addEventListener("focusin", () => {
  if (!isMobilePortrait()) return;
  const active = document.activeElement;
  const inInputs = (active === brandInput || active === modelInput);
  if (!inInputs) shrinkInputs();
});
    // --- Submit search ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
shrinkInputs();
      let brandTyped = sanitizeInput(brandInput.value);
      brandTyped = resolveClosestBrand(brandTyped);
      brandInput.value = brandTyped;

      const modelTyped = sanitizeInput(modelInput.value);

      updateFetchReady();

      if (!brandTyped && !modelTyped) {
        statusMessageEl.textContent = "Please enter a brand and/or a model.";
        return;
      }

      currentSearch = { brand: brandTyped, model: modelTyped };
      const displayQuery = [brandTyped, modelTyped].filter(Boolean).join(" ").trim();
      if (!displayQuery) {
        statusMessageEl.textContent = "Please enter a brand and/or a model.";
        return;
      }

      statusMessageEl.textContent = "Searching dealsâ€¦";
      resultsEl.innerHTML = "";

      const pager = document.querySelector(".pager");
      if (pager) pager.style.display = "none";
      if (loadMoreWrap) loadMoreWrap.style.display = "none";

      if (dailyDeals) dailyDeals.style.display = "none";
      if (filtersEl) filtersEl.style.display = "none";

      let data;
      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query: displayQuery }));
        data = await res.json();
      } catch (err) {
        console.error("Search error:", err);
        statusMessageEl.textContent = "Search failed. Please try again.";
        if (dailyDeals) dailyDeals.style.display = "block";
        return;
      }

      const results = (data && data.results) ? data.results : [];
      lastSearchResults = results;

      selectedGender = "";
      selectedShoeType = "";
      if (genderChips) setActiveChip(genderChips, genderChips.querySelector('.chip[data-gender=""]'));
      if (typeChips) setActiveChip(typeChips, typeChips.querySelector('.chip[data-type=""]'));

      if (!results.length) {
        statusMessageEl.textContent = `No results found for ${displayQuery}.`;
        if (filtersEl) filtersEl.style.display = "none";
        if (pager) pager.style.display = "none";
        if (loadMoreWrap) loadMoreWrap.style.display = "none";
        if (dailyDeals) dailyDeals.style.display = "block";
        return;
      }

      const genderRow = genderChips ? genderChips.closest(".filter-row") : null;
      if (genderRow) genderRow.style.display = "flex";

      const typeRow = typeChips ? typeChips.closest(".filter-row") : null;

      const hasBrand = !!brandTyped.trim();
      const hasModel = !!modelTyped.trim();

      if (typeRow) {
        if (hasBrand && !hasModel) {
          typeRow.style.display = "flex";
          if (typeChips) setActiveChip(typeChips, typeChips.querySelector('.chip[data-type=""]'));
        } else {
          typeRow.style.display = "none";
          selectedShoeType = "";
        }
      }

      if (filtersEl) filtersEl.style.display = "flex";

      // âœ… show first 12; nav UI will decide pager vs load-more
      renderFilteredResults({ resetPage: true, append: false });
    });

    brandInput.addEventListener("input", updateFetchReady);
    modelInput.addEventListener("input", updateFetchReady);
  })();
  </script>
</body>
</html>
