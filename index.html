<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                 img-src * data: https:;
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self' https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com;
                 font-src 'self';
                 frame-src 'none';">
  <title>Shoe Beagle--The Running Shoe Deal Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    .card { position: relative; }

    .card-image-wrapper {
      position: relative;
      width: 100%;
    }

    .discount-badge {
      position: absolute;
      top: 0.35rem;
      left: 0.35rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      background: rgba(220, 53, 69, 0.9);
      color: #ffffff;
      z-index: 3;
    }

    @media (max-width: 480px) {
      .discount-badge {
        top: 0.2rem;
        left: 0.2rem;
        padding: 0.1rem 0.3rem;
        font-size: 0.55rem;
      }
    }

    .card-original-price {
      margin-left: 0.35rem;
      font-size: 0.8rem;
      color: #777;
      text-decoration: line-through;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4ede3ff;
      color: #2d2d2d;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 6px 1rem;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      align-items: center;
      padding-top: 0;
    }

    :root{
      --input-h: 42px;
      --stack-gap: 10px;
      --btn-w: 42px; /* menu button width */
      --btn-wide: 90px; /* fetch button width */
    }

    /* --- TOP BAR (logo left, 2 stacked rows right) --- */
    .topbar{
      width: 100%;
      max-width: 900px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }

    .brand{
      display: flex;
      align-items: flex-start;
      flex: 0 0 auto;
    }

    /* EXACT: same height as the two search bars (includes gap) */
    .brand-logo{
      height: calc(var(--input-h) * 2 + var(--stack-gap));
      width: auto;
      max-width: 280px;
      object-fit: contain;
      margin: 0;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .brand-logo:hover { opacity: 0.9; }

    form#search-form{
      flex: 1 1 auto;
      width: 100%;
      max-width: 650px;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: var(--stack-gap);
      justify-content: flex-start;
      align-items: stretch;
    }

    /* Each row = input + button to the right */
    .input-row{
      display: flex;
      align-items: stretch;
      gap: 10px;
      width: 100%;
    }

    input[type="text"],
    input[type="search"] {
      width: 100%;
      height: var(--input-h);
      padding: 0 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #fafdf4;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      color: #444;
    }

    .input-wrapper {
      position: relative;
      flex: 1 1 auto;
      width: 100%;
      max-width: none;
    }

    input::placeholder { color: #999; opacity: 1; }

    .input-clear {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #999;
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      padding: 0;
      line-height: 1;
      z-index: 20;
    }
    .input-clear:hover { background: #666; }
    .input-wrapper:has(input:not(:placeholder-shown)) .input-clear { display: flex; }

    /* MENU BUTTON (right of brand input) */
    .menu-wrapper {
      position: relative;
      flex: 0 0 auto;
      display: flex;
      align-items: center;
    }

    .menu-btn {
      height: var(--input-h);
      width: var(--btn-w);
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
    }
    .menu-btn:hover { background: #1a3661; }
    .menu-icon { font-size: 1.2rem; }

    .menu-dropdown {
      position: absolute;
      top: calc(100% + 0.25rem);
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      min-width: 150px;
      display: none;
      z-index: 100;
    }
    .menu-dropdown.show { display: block; }

    .menu-dropdown a {
      display: block;
      padding: 0.65rem 1rem;
      color: #214478ff;
      text-decoration: none;
      font-size: 0.95rem;
      transition: background 0.2s ease;
    }
    .menu-dropdown a:hover { background: #e8f0ff; }

    /* FETCH BUTTON (right of model input) */
    .search-btn {
      height: var(--input-h);
      width: var(--btn-wide);
      border-radius: 0.5rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      padding: 0 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      outline: none;
      cursor: pointer;
    }
    .search-btn:hover { background: #1a3661; }

    .search-btn:disabled {
      opacity: 1;
      cursor: pointer;
      pointer-events: none;
    }

    .suggestions {
      position: absolute;
      top: calc(var(--input-h) + 4px);
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #214478ff;
      border-radius: 0.5rem;
      margin-top: 0.15rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      z-index: 30;
      padding: 0.25rem 0;
      display: none;
    }

    .suggestion-item {
      padding: 0.25rem 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .suggestion-item:hover { background: #e8f0ff; }
    .suggestion-item.active { background: #e8f0ff; }

    button {
      border: none;
      border-radius: 0.75rem;
      background: #214478ff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    .status-message {
      font-size: 0.95rem;
      color: #2d3c22;
      margin-top: 0.05rem;
      text-align: center;
      width: 100%;
      min-height: 1.1rem;
    }

    .filters{
      width:100%;
      max-width:650px;
      display:flex;
      flex-direction:row;
      align-items:center;
      justify-content:center;
      gap:1rem;
      margin-top: 0.1rem;
      flex-wrap:wrap;
    }

    .filter-row{
      display:flex;
      align-items:center;
      gap:0.5rem;
      flex-wrap:wrap;
    }

    .filter-label{
      font-size:0.9rem;
      font-weight:700;
      color:#214478ff;
      white-space:nowrap;
    }

    .chip-group{
      display:flex;
      align-items:center;
      gap:0.4rem;
      flex-wrap:wrap;
    }

    .chip{
      border:1px solid #214478ff;
      background:#fafdf4;
      color:#214478ff;
      width: 27px;
      height: 27px;
      border-radius: 999px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 800;
      line-height: 1;
      cursor:pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.05s ease, box-shadow 0.2s ease;
      position: relative;
    }

    .chip:hover{ background:#e8f0ff; }
    .chip.active{
      background:#214478ff;
      color:#ffffff;
      box-shadow: 0 2px 6px rgba(33, 68, 120, 0.25);
    }
    .chip:active{ transform: scale(0.98); }

    .chip[aria-label]::after{
      content: attr(aria-label);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 8px);
      transform: translateX(-50%);
      background: rgba(0,0,0,0.82);
      color: #fff;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 6px 8px;
      border-radius: 8px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease, transform 0.12s ease;
      z-index: 50;
    }

    .chip[aria-label]::before{
      content: "";
      position: absolute;
      left: 50%;
      bottom: calc(100% + 2px);
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0,0,0,0.82);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease;
      z-index: 50;
    }

    .chip:hover::after{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }
    .chip:hover::before{ opacity: 1; }

    .card-tags {
      position: absolute;
      left: 0.35rem;
      right: 0.35rem;
      bottom: 0.35rem;
      display: flex;
      gap: 0.35rem;
      justify-content: space-between;
      align-items: center;
      z-index: 2;
      pointer-events: none;
    }

    .card-tag {
      font-size: 0.68rem;
      font-weight: 600;
      color: #214478ff;
      line-height: 1.1;
      white-space: nowrap;
      text-shadow: 0 0 3px rgba(255,255,255,0.8), 0 0 5px rgba(255,255,255,0.6);
    }

    .daily-deals {
      width: 100%;
      max-width: 900px;
      margin-top: 1.0rem;
    }

    .daily-deals-header {
      font-size: 1.8rem;
      font-weight: 700;
      color: #214478ff;
      margin-bottom: 1rem;
      text-align: center;
    }

    .shoe-grid {
      margin-top: 1.0rem;
      display: grid;
      gap: 1.25rem;
      width: 100%;
      justify-content: center;
      max-width: 900px;
      grid-template-columns: repeat(var(--grid-columns, auto-fit), minmax(min(100%, 180px), 1fr));
    }

    .shoe-grid .card {
      max-width: 240px;
      margin: 0 auto;
      width: 100%;
    }

    @media (max-width: 480px) {
      .shoe-grid {
        grid-template-columns: 1fr;
        max-width: 100%;
      }
      .shoe-grid .card {
        max-width: 100%;
      }
    }

    .card {
      background: #d9e1ebff;
      border: 2px solid #214478ff;
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      text-align: left;
      box-sizing: border-box;
    }

    .card-link {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      text-decoration: none;
      color: inherit;
      height: 100%;
    }

    .card-image-wrapper {
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    .card img {
      width: 100%;
      height: 150px;
      border-radius: 0.6rem;
      object-fit: contain;
      background: white;
      border: 1px solid #214478ff;
      box-sizing: border-box;
    }

    .card-content {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      flex: 1;
    }

    .card-title {
      font-size: 0.92rem;
      font-weight: 600;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: calc(1.2em * 3);
    }

    .card-store {
      font-size: 0.82rem;
      color: #49543a;
    }

    .card-price-row {
      display: flex;
      align-items: baseline;
      gap: 0.3rem;
      font-size: 0.95rem;
    }

    .price {
      font-weight: 700;
      color: #214478ff;
    }

    @media (max-width: 480px) {
      .topbar{
        flex-direction: column;
        align-items: center;
      }

      .brand{
        justify-content: center;
      }

      /* On mobile, keep it simple: logo above, inputs below */
      .brand-logo{
        height: 64px;
        max-width: 280px;
      }

      form#search-form{
        max-width: 100%;
      }

      .input-row{
        gap: 10px;
      }

      .search-btn{
        width: 100%;
        max-width: 140px;
      }

      .card-link {
        flex-direction: row;
        gap: 0.75rem;
        align-items: center;
      }

      .card-image-wrapper {
        flex-shrink: 0;
        width: 100px;
        height: 80px;
        overflow: hidden;
      }

      .card img {
        height: 80px;
        object-fit: cover;
      }

      .card-tags {
        left: 0.25rem;
        right: 0.25rem;
        bottom: 0.25rem;
      }

      .card-tag {
        font-size: 0.62rem;
      }

      .card-content {
        justify-content: center;
        min-width: 0;
      }

      .card-title {
        -webkit-line-clamp: 2;
        min-height: auto;
      }
    }

    @media (min-width: 481px) and (max-width: 900px) and (orientation: landscape) {
      .shoe-grid {
        grid-template-columns: repeat(var(--grid-columns, 3), minmax(min(100%, 180px), 1fr));
      }
    }

    .load-more-wrap{
      width:100%;
      display:flex;
      justify-content:center;
      margin: 1rem 0 0.5rem;
    }

    .load-more-btn{
      height: 42px;
      padding: 0 1.25rem;
      border-radius: 0.75rem;
      border: 1px solid #214478ff;
      background: #214478ff;
      color:#fff;
      font-weight:700;
    }
    .load-more-btn:hover{ background:#1a3661; }

    .disclaimer {
      font-size: 0.8rem;
      color: #555;
      max-width: 900px;
      margin: 0.15rem auto 0;
      text-align: center;
    }

    .footer {
      margin-top: 2rem;
      padding: 0.75rem 1rem;
      background: rgba(244, 237, 227, 0.97);
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      font-size: 0.82rem;
      color: #444;
      text-align: center;
    }

    .footer a {
      color: #214478ff;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      margin: 0 0.25rem;
    }

    .footer a:hover { text-decoration: underline; }
  </style>

  <!--
    IMPORTANT:
    Set this at deploy time to avoid hardcoding the blob store base.
    Example value:
      https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com
  -->
  <meta name="shoebeagle-blob-base" content="__BLOB_BASE_URL__">
</head>

<body>
  <div style="display:none;">Impact-Site-Verification: 484b0fd5-0544-4654-b916-4e921a2e5077</div>

  <div class="app">

    <!-- TOP BAR: logo (left) + 2 stacked rows (right)
         Row 1: Brand input + Menu button
         Row 2: Model input + Fetch button
    -->
    <div class="topbar">
      <div class="brand">
        <img src="/images/logoV2.svg" class="brand-logo" alt="Shoe Beagle Logo" id="logoLink">
      </div>

      <form id="search-form" method="POST">
        <!-- Row 1 -->
        <div class="input-row">
          <div class="input-wrapper">
            <input id="brand" type="text" placeholder="Enter Shoe Brand" autocomplete="off"/>
            <button type="button" class="input-clear" aria-label="Clear brand">&times;</button>
            <div id="brandSuggestions" class="suggestions"></div>
          </div>

          <div class="menu-wrapper">
            <button id="menuBtn" type="button" class="menu-btn" aria-label="Menu">
              <span class="menu-icon">☰</span>
            </button>
            <div id="menuDropdown" class="menu-dropdown">
              <a href="/pages/myalerts.html">My Alerts</a>
              <a href="/pages/setalert.html">Set Alert</a>
            </div>
          </div>
        </div>

        <!-- Row 2 -->
        <div class="input-row">
          <div class="input-wrapper">
            <input id="model" type="text" placeholder="Enter Shoe Model" autocomplete="off"/>
            <button type="button" class="input-clear" aria-label="Clear model">&times;</button>
            <div id="modelSuggestions" class="suggestions"></div>
          </div>

          <button id="fetchBtn" type="submit" class="search-btn">Fetch!</button>
        </div>
      </form>
    </div>

    <div class="status-message" id="statusMessage">Let's find your running shoes!</div>

    <div class="filters" id="filters" style="display:none;">
      <div class="filter-row">
        <div class="filter-label">Gender:</div>
        <div class="chip-group" id="genderChips">
          <button type="button" class="chip active" data-gender="" aria-label="Filter off">&times;</button>
          <button type="button" class="chip" data-gender="mens" aria-label="Men's">M</button>
          <button type="button" class="chip" data-gender="womens" aria-label="Women's">W</button>
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-label">Shoe type:</div>
        <div class="chip-group" id="typeChips">
          <button type="button" class="chip active" data-type="" aria-label="Filter off">&times;</button>
          <button type="button" class="chip" data-type="road" aria-label="Road">R</button>
          <button type="button" class="chip" data-type="trail" aria-label="Trail">T</button>
          <button type="button" class="chip" data-type="track" aria-label="Spikes">S</button>
        </div>
      </div>
    </div>

    <div id="mainContent">
      <div class="daily-deals" id="dailyDeals">
        <div class="daily-deals-header">Marty's Daily Deals</div>
        <div class="shoe-grid" id="dailyDealsGrid"></div>
      </div>

      <div class="shoe-grid" id="results"></div>

      <div class="load-more-wrap" id="loadMoreWrap" style="display:none;">
        <button type="button" class="load-more-btn" id="loadMoreBtn">Load More…</button>
      </div>

      <p class="disclaimer">Shoe Beagle does not sell products directly and is not responsible for changes in price, availability, or shipping terms on retailer sites.</p>
    </div>

    <div class="footer">
      <a href="/pages/about.html">About</a> |
      <a href="/pages/contact.html">Contact</a> |
      <a href="/pages/privacy.html">Privacy</a> |
      <a href="/pages/terms.html">Terms</a> |
      <br>
      © <span id="footerYear"></span> Shoe Beagle. All rights reserved.
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script>
    const form = document.getElementById("search-form");

    const statusMessageEl = document.getElementById("statusMessage");
    const resultsEl = document.getElementById("results");
    const dailyDeals = document.getElementById("dailyDeals");
    const dailyDealsGrid = document.getElementById("dailyDealsGrid");
    const fetchBtn = document.getElementById("fetchBtn");
    const brandInput = document.getElementById("brand");
    const modelInput = document.getElementById("model");
    const brandSuggestions = document.getElementById("brandSuggestions");
    const modelSuggestions = document.getElementById("modelSuggestions");
    const logoLink = document.getElementById("logoLink");
    const footerYear = document.getElementById("footerYear");
    const menuBtn = document.getElementById("menuBtn");
    const menuDropdown = document.getElementById("menuDropdown");

    const filtersEl = document.getElementById("filters");
    const genderChips = document.getElementById("genderChips");
    const typeChips = document.getElementById("typeChips");

    const PAGE_SIZE = 12;
    let visibleCount = 0;
    const loadMoreWrap = document.getElementById("loadMoreWrap");
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    let currentSearch = { brand: "", model: "" };
    let lastSearchResults = [];
    let selectedGender = "";
    let selectedShoeType = "";

    if (footerYear) footerYear.textContent = new Date().getFullYear();
    if (logoLink) logoLink.addEventListener("click", () => location.reload());

    // --- Menu dropdown ---
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle("show");
    });

    menuBtn.addEventListener("mouseenter", () => menuDropdown.classList.add("show"));
    menuDropdown.addEventListener("mouseenter", () => menuDropdown.classList.add("show"));

    menuBtn.addEventListener("mouseleave", () => {
      setTimeout(() => {
        if (!menuDropdown.matches(':hover') && !menuBtn.matches(':hover')) {
          menuDropdown.classList.remove("show");
        }
      }, 100);
    });

    menuDropdown.addEventListener("mouseleave", () => {
      setTimeout(() => {
        if (!menuDropdown.matches(':hover') && !menuBtn.matches(':hover')) {
          menuDropdown.classList.remove("show");
        }
      }, 100);
    });

    document.addEventListener("click", (e) => {
      if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
        menuDropdown.classList.remove("show");
      }
    });

    // --- Helpers ---
    function normalizeStr(s) { return String(s || "").trim().toLowerCase(); }
    function normalizeEnum(s) { return String(s || "").trim().toLowerCase(); }

    function sanitizeInput(str) {
      return String(str || "")
        .replace(/[<>'"]/g, '')
        .replace(/script/gi, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .trim()
        .slice(0, 100);
    }

    function updateFetchReady() {
      const hasAny = !!(brandInput.value.trim() || modelInput.value.trim());
      fetchBtn.disabled = !hasAny;
    }
    updateFetchReady();

    document.querySelectorAll('.input-clear').forEach((clearBtn, index) => {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const input = clearBtn.previousElementSibling;
        if (input && input.tagName === 'INPUT') {
          input.value = '';
          input.focus();
          if (index === 0) closeSuggestions("brand");
          else closeSuggestions("model");
          updateFetchReady();
        }
      });
    });

    function isValidRetailerUrl(url) {
      if (!url || url === '#') return false;
      try {
        const u = new URL(url);
        return u.protocol === "https:" || u.protocol === "http:";
      } catch {
        return false;
      }
    }

    // --- Blob base (NO hardcoding) ---
    function getBlobBase() {
      const meta = document.querySelector('meta[name="shoebeagle-blob-base"]');
      const fromMeta = meta ? String(meta.getAttribute("content") || "").trim() : "";

      const looksLikePlaceholder = fromMeta.includes("__BLOB_BASE_URL__");
      if (fromMeta && !looksLikePlaceholder) return fromMeta.replace(/\/+$/, "");

      return "https://v3gjlrmpc76mymfc.public.blob.vercel-storage.com";
    }

    function blobUrl(path) {
      const base = getBlobBase();
      const cleanPath = String(path || "").replace(/^\/+/, "");
      return base.replace(/\/+$/, "") + "/" + cleanPath;
    }

    function withCacheBust(url) {
      const u = new URL(url, window.location.origin);
      u.searchParams.set("cb", String(Date.now()));
      return u.toString();
    }

    // UPDATED: uses schema: salePrice, originalPrice, discountPercent
    function getDiscountInfo(item) {
      const current = Number(item.salePrice);
      const original = Number(item.originalPrice);

      if (Number.isFinite(current) && Number.isFinite(original) && original > 0 && current < original) {
        const pct = Math.round(((original - current) / original) * 100);
        return { hasDiscount: true, current: current.toFixed(2), original: original.toFixed(2), percent: pct };
      }

      const pct2 = Number(item.discountPercent);
      if (Number.isFinite(current) && Number.isFinite(pct2) && pct2 > 0 && pct2 < 100) {
        const origGuess = current / (1 - pct2 / 100);
        if (Number.isFinite(origGuess) && origGuess > current) {
          return { hasDiscount: true, current: current.toFixed(2), original: origGuess.toFixed(2), percent: Math.round(pct2) };
        }
        return { hasDiscount: true, current: current.toFixed(2), original: "", percent: Math.round(pct2) };
      }

      return { hasDiscount: false };
    }

    // --- Brand + model dictionary ---
    const brandModels = {
      "361°": ["Spire","Fury","Strata","Flame"],
      "Adidas": ["Adizero Adios","Adizero Boston","Adizero Takumi Sen","Supernova","Ultraboost Light"],
      "Allbirds": ["Tree Dasher","Tree Flyer","Trail Runner SWT","Tree Dashers Relay"],
      "Altra": ["Escalante","Torin","Lone Peak","Paradigm","Provision"],
      "Asics": ["Novablast","Gel-Kayano","Gel-Nimbus","Gel-Cumulus","Metaspeed Sky"],
      "Atreyu": ["Base Model","Artist","Race Model","Daily Trainer"],
      "Brooks": ["Ghost","Glycerin","Adrenaline GTS","Launch","Hyperion"],
      "Craft": ["CTM Ultra","CTM Ultra Carbon","Pro Endur","Nordlite"],
      "Decathlon Kiprun": ["KD900","KS900","Ultralight","Race Light"],
      "Diadora": ["Mythos Blushield","Equilibrium","Elite Volo"],
      "Hoka": ["Clifton","Bondi","Mach","Rincon","Arahi","Carbon X"],
      "Inov-8": ["Roadfly","Trailfly","Roclite","Mudtalon","X-Talon"],
      "Joe Nimble": ["Addict","Trail Addict","Ultreya","WanderToes"],
      "Karhu": ["Fusion","Ikoni","Synchron"],
      "La Sportiva": ["Jackal","Akasha","Karacal","Mutant","Kaptiva"],
      "Lems": ["Primal","Primal 2","Trailhead","Mesa"],
      "Merrell": ["Vapor Glove","Trail Glove","Agility Peak","Long Sky","Morphlite"],
      "Mizuno": ["Wave Rider","Wave Inspire","Wave Rebellion","Wave Sky"],
      "New Balance": ["Fresh Foam 1080","FuelCell Rebel","Fresh Foam X 880","Fresh Foam More","RC Elite"],
      "Newton": ["Gravity","Distance","Motion","Fate","Kismet"],
      "Nike": ["Pegasus","ZoomX Vaporfly","Alphafly","Infinity Run","Structure"],
      "Norda": ["001","002","003"],
      "On": ["Cloudsurfer","Cloudmonster","Cloudflow","Cloudstratus","Cloudboom Echo"],
      "Pearl Izumi": ["Flow","Floatride","Trail N2","Road N1"],
      "Puma": ["Deviate Nitro","Velocity Nitro","Magnify Nitro"],
      "Reebok": ["Floatride Energy","Floatride Run Fast"],
      "Salomon": ["S/Lab Pulsar","Sense Ride","Ultra Glide"],
      "Saucony": ["Ride","Endorphin Speed","Endorphin Pro","Kinvara","Triumph","Guide"],
      "Skechers": ["GOrun Ride","GOrun Razor","MaxRoad"],
      "Topo Athletic": ["Ultrafly","Phantom","Fly Lite"],
      "Under Armour": ["HOVR Machina","HOVR Infinite","Charged Assert"],
      "Vibram FiveFingers": ["V-Run","V-Trail","V-Alpha","KSO EVO","V-Trek"],
      "Vivobarefoot": ["Primus Lite","Primus Trail","Geo Racer","Stealth","Addis"],
      "Xero Shoes": ["HFS","Prio","Speed Force","Mesa Trail","Zelen"]
    };

    const brands = Object.keys(brandModels).sort((a,b) => a.localeCompare(b));

    function squashStr(s) { return String(s || "").toLowerCase().replace(/[^a-z0-9]/g, ""); }

    function scoreSuggestion(candidate, query) {
      const c = String(candidate || "");
      const cl = c.toLowerCase();
      const q = String(query || "").trim().toLowerCase();
      if (!q) return 0;

      const cSquash = squashStr(c);
      const qSquash = squashStr(q);

      let score = 0;
      if (cl.startsWith(q)) score += 120;
      if (cl.includes(q)) score += 80;
      if (qSquash.length >= 3 && cSquash.includes(qSquash)) score += 110;

      const qParts = q.split(/\s+/).filter(Boolean);
      if (qParts.length >= 2) {
        const cParts = cl.split(/\s+/);
        let tokenHits = 0;
        for (const qp of qParts) {
          if (cParts.some(cp => cp.startsWith(qp))) tokenHits++;
        }
        score += tokenHits * 25;
      }

      score -= Math.min(c.length, 30) * 0.25;
      return score;
    }

    function levenshtein(a, b) {
      a = String(a || "");
      b = String(b || "");
      const m = a.length, n = b.length;
      if (!m) return n;
      if (!n) return m;

      const dp = new Array(n + 1);
      for (let j = 0; j <= n; j++) dp[j] = j;

      for (let i = 1; i <= m; i++) {
        let prev = dp[0];
        dp[0] = i;
        for (let j = 1; j <= n; j++) {
          const temp = dp[j];
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[j] = Math.min(dp[j] + 1, dp[j - 1] + 1, prev + cost);
          prev = temp;
        }
      }
      return dp[n];
    }

    function resolveClosestBrand(input) {
      const raw = String(input || "").trim();
      if (!raw) return "";

      const exact = brands.find(b => normalizeStr(b) === normalizeStr(raw));
      if (exact) return exact;

      const q = squashStr(raw);
      if (!q) return raw;

      let best = null;
      let bestDist = Infinity;

      for (const b of brands) {
        const bs = squashStr(b);
        const d = levenshtein(q, bs);
        if (d < bestDist) {
          bestDist = d;
          best = b;
        }
      }

      const len = q.length;
      const threshold = len <= 4 ? 1 : (len <= 7 ? 2 : 3);
      return (best != null && bestDist <= threshold) ? best : raw;
    }

    function filterSuggestions(list, typed, limit = 10) {
      const q = String(typed || "").trim();
      if (!q) return [];

      const qLower = q.toLowerCase();
      const starts = list.filter(v => String(v).toLowerCase().startsWith(qLower));
      if (starts.length) {
        const ranked = starts
          .map(v => ({ v, s: scoreSuggestion(v, q) }))
          .sort((a, b) => b.s - a.s)
          .slice(0, limit)
          .map(x => x.v);
        return Array.from(new Set(ranked));
      }

      const scored = list
        .map(v => ({ v, s: scoreSuggestion(v, q) }))
        .filter(x => x.s > 0)
        .sort((a, b) => b.s - a.s)
        .slice(0, limit)
        .map(x => x.v);

      return Array.from(new Set(scored));
    }

    const allModels = (() => {
      const flat = [];
      for (const b of Object.keys(brandModels)) {
        const arr = brandModels[b];
        if (Array.isArray(arr)) flat.push(...arr);
      }
      return Array.from(new Set(flat)).sort((a, b) => a.localeCompare(b));
    })();

    function resolveBrandKey(input) {
      const normalized = normalizeStr(input);
      return brands.find(b => normalizeStr(b) === normalized) || "";
    }
    function resolveBrand() { return resolveBrandKey(brandInput.value.trim()); }

    const suggestionState = { openFor: null, items: [], activeIndex: -1 };

    function closeSuggestions(which) {
      if (!which || which === "brand") {
        brandSuggestions.style.display = "none";
        brandSuggestions.innerHTML = "";
      }
      if (!which || which === "model") {
        modelSuggestions.style.display = "none";
        modelSuggestions.innerHTML = "";
      }

      if (!which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      } else if (suggestionState.openFor === which) {
        suggestionState.openFor = null;
        suggestionState.items = [];
        suggestionState.activeIndex = -1;
      }
    }

    function renderSuggestions(container, items, which, onPick) {
      container.innerHTML = "";

      if (!items.length) {
        container.style.display = "none";
        if (suggestionState.openFor === which) {
          suggestionState.openFor = null;
          suggestionState.items = [];
          suggestionState.activeIndex = -1;
        }
        return;
      }

      suggestionState.openFor = which;
      suggestionState.items = items.slice();
      suggestionState.activeIndex = -1;

      items.forEach((value, idx) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = value;
        div.dataset.index = String(idx);

        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          onPick(value);
        });

        container.appendChild(div);
      });

      container.style.display = "block";
    }

    function highlightActive(container) {
      const children = Array.from(container.querySelectorAll(".suggestion-item"));
      children.forEach(el => el.classList.remove("active"));

      if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < children.length) {
        const active = children[suggestionState.activeIndex];
        active.classList.add("active");

        const box = container;
        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;
        if (top < box.scrollTop) box.scrollTop = top;
        else if (bottom > box.scrollTop + box.clientHeight) box.scrollTop = bottom - box.clientHeight;
      }
    }

    function handleSuggestionKeys(e, which, container, onPick) {
      if (suggestionState.openFor !== which) return;

      const max = suggestionState.items.length;
      if (!max) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex + 1) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        suggestionState.activeIndex = (suggestionState.activeIndex - 1 + max) % max;
        highlightActive(container);
        return;
      }

      if (e.key === "Enter") {
        if (suggestionState.activeIndex >= 0 && suggestionState.activeIndex < max) {
          e.preventDefault();
          const value = suggestionState.items[suggestionState.activeIndex];
          onPick(value);
        }
        return;
      }

      if (e.key === "Escape") {
        e.preventDefault();
        closeSuggestions(which);
        return;
      }
    }

    brandInput.addEventListener("input", () => {
      const typed = brandInput.value.trim();
      if (typed.length < 1) {
        closeSuggestions("brand");
        updateFetchReady();
        return;
      }

      const matches = filterSuggestions(brands, typed, 12);
      renderSuggestions(brandSuggestions, matches, "brand", (value) => {
        brandInput.value = value;
        closeSuggestions("brand");
        setTimeout(() => modelInput.focus(), 0);
        updateFetchReady();
      });

      updateFetchReady();
    });

    brandInput.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "brand", brandSuggestions, (value) => {
        brandInput.value = value;
        closeSuggestions("brand");
        setTimeout(() => modelInput.focus(), 0);
        updateFetchReady();
      });
    });

    brandInput.addEventListener("blur", () => setTimeout(() => closeSuggestions("brand"), 140));

    modelInput.addEventListener("input", () => {
      const text = modelInput.value.trim();
      if (text.length < 1) {
        closeSuggestions("model");
        updateFetchReady();
        return;
      }

      const brandKey = resolveBrand();
      const pool = (brandKey && Array.isArray(brandModels[brandKey])) ? brandModels[brandKey] : allModels;

      const matches = filterSuggestions(pool, text, 12);
      renderSuggestions(modelSuggestions, matches, "model", (value) => {
        modelInput.value = value;
        closeSuggestions("model");
        setTimeout(() => fetchBtn.focus(), 0);
        updateFetchReady();
      });

      updateFetchReady();
    });

    modelInput.addEventListener("keydown", (e) => {
      handleSuggestionKeys(e, "model", modelSuggestions, (value) => {
        modelInput.value = value;
        closeSuggestions("model");
        setTimeout(() => fetchBtn.focus(), 0);
        updateFetchReady();
      });
    });

    modelInput.addEventListener("blur", () => setTimeout(() => closeSuggestions("model"), 140));

    brandInput.addEventListener("click", () => brandInput.select());
    modelInput.addEventListener("click", () => modelInput.select());

    document.addEventListener("click", (e) => {
      const insideBrand = brandSuggestions.contains(e.target) || brandInput.contains(e.target);
      const insideModel = modelSuggestions.contains(e.target) || modelInput.contains(e.target);
      if (!insideBrand) closeSuggestions("brand");
      if (!insideModel) closeSuggestions("model");
    });

    function setActiveChip(groupEl, activeBtn) {
      if (!groupEl) return;
      groupEl.querySelectorAll(".chip").forEach(btn => btn.classList.remove("active"));
      if (activeBtn) activeBtn.classList.add("active");
    }

    function applyFilters(items) {
      const g = normalizeEnum(selectedGender);
      const t = normalizeEnum(selectedShoeType);

      return (items || []).filter(item => {
        const itemGender = normalizeEnum(item.gender);
        const itemType = normalizeEnum(item.shoeType);

        const genderOk = !g || itemGender === g || itemGender === "unisex";
        const typeOk = !t || itemType === t;

        return genderOk && typeOk;
      });
    }

    function renderFilteredResults(resetPagination = true) {
      const filtered = applyFilters(lastSearchResults);

      if (resetPagination) visibleCount = PAGE_SIZE;
      const shown = filtered.slice(0, visibleCount);

      resultsEl.innerHTML = "";
      shown.forEach(item => resultsEl.appendChild(createDealCard(item)));

      const displayQuery = [currentSearch.brand, currentSearch.model].filter(Boolean).join(" ").trim() || "all shoes";

      if (!filtered.length) {
        statusMessageEl.textContent = `No results match your filters for ${displayQuery}.`;
        if (loadMoreWrap) loadMoreWrap.style.display = "none";
        return;
      }

      statusMessageEl.textContent =
        `Showing ${shown.length} of ${filtered.length} deal${filtered.length === 1 ? "" : "s"} for ${displayQuery}.`;

      if (loadMoreWrap) {
        loadMoreWrap.style.display = (shown.length < filtered.length) ? "flex" : "none";
      }
    }

    if (loadMoreBtn) {
      loadMoreBtn.addEventListener("click", () => {
        visibleCount += PAGE_SIZE;
        renderFilteredResults(false);
      });
    }

    if (genderChips) {
      genderChips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if (!btn) return;
        selectedGender = normalizeEnum(btn.dataset.gender);
        setActiveChip(genderChips, btn);
        renderFilteredResults(true);
      });
    }

    if (typeChips) {
      typeChips.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if (!btn) return;
        selectedShoeType = normalizeEnum(btn.dataset.type);
        setActiveChip(typeChips, btn);
        renderFilteredResults(true);
      });
    }

    function createDealCard(item) {
      const discount = getDiscountInfo(item);

      const card = document.createElement("div");
      card.className = "card";

      const link = document.createElement("a");
      link.className = "card-link";

      const listingUrl = item.listingURL;
      const safeLink = isValidRetailerUrl(listingUrl) ? listingUrl : "#";
      if (safeLink === "#" && listingUrl) console.warn("Blocked untrusted retailer URL:", listingUrl);

      link.href = safeLink;
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      const imgWrapper = document.createElement("div");
      imgWrapper.className = "card-image-wrapper";

      const img = document.createElement("img");
      img.src = item.imageURL ? item.imageURL : "https://placehold.co/600x400?text=Running+Shoe";
      img.alt = (item.brand && item.model) ? `${item.brand} ${item.model}` : (item.model || item.brand || "Running shoe deal");
      imgWrapper.appendChild(img);

      if (discount.hasDiscount) {
        const badge = document.createElement("div");
        badge.className = "discount-badge";
        badge.textContent = `${discount.percent}% OFF`;
        imgWrapper.appendChild(badge);
      }

      const g = normalizeEnum(item.gender);
      const t = normalizeEnum(item.shoeType);

      const tagWrap = document.createElement("div");
      tagWrap.className = "card-tags";

      let hasAnyTag = false;

      if (g) {
        const genderTag = document.createElement("span");
        genderTag.className = "card-tag";
        genderTag.textContent = g === "mens" ? "Mens" : g === "womens" ? "Womens" : "Unisex";
        tagWrap.appendChild(genderTag);
        hasAnyTag = true;
      }

      if (t) {
        const typeTag = document.createElement("span");
        typeTag.className = "card-tag";
        typeTag.textContent =
          t === "road" ? "Road" :
          t === "trail" ? "Trail" :
          t === "track" ? "Spikes" : (item.shoeType || "");
        tagWrap.appendChild(typeTag);
        hasAnyTag = true;
      }

      if (hasAnyTag) imgWrapper.appendChild(tagWrap);

      link.appendChild(imgWrapper);

      const contentDiv = document.createElement("div");
      contentDiv.className = "card-content";

      const titleDiv = document.createElement("div");
      titleDiv.className = "card-title";

      const brand = (item.brand || "").trim();
      const model = (item.model || "").trim();

      if (brand && model) {
        titleDiv.innerHTML = `<strong style="text-transform: uppercase;">${brand}</strong><br>${model}`;
      } else if (brand) {
        titleDiv.innerHTML = `<strong style="text-transform: uppercase;">${brand}</strong>`;
      } else if (model) {
        titleDiv.textContent = model;
      } else {
        titleDiv.textContent = "Deal";
      }

      contentDiv.appendChild(titleDiv);

      if (item.store) {
        const storeDiv = document.createElement("div");
        storeDiv.className = "card-store";
        storeDiv.textContent = item.store;
        contentDiv.appendChild(storeDiv);
      }

      const priceRow = document.createElement("div");
      priceRow.className = "card-price-row";

      const priceSpan = document.createElement("span");
      priceSpan.className = "price";

      const currentPrice = Number(item.salePrice);
      if (Number.isFinite(currentPrice)) priceSpan.textContent = `$${currentPrice.toFixed(2)}`;
      else priceSpan.textContent = item.salePrice != null ? String(item.salePrice) : "—";

      priceRow.appendChild(priceSpan);

      if (discount.hasDiscount && discount.original) {
        const origSpan = document.createElement("span");
        origSpan.className = "card-original-price";
        origSpan.textContent = `$${discount.original}`;
        priceRow.appendChild(origSpan);
      }

      contentDiv.appendChild(priceRow);
      link.appendChild(contentDiv);

      card.appendChild(link);
      return card;
    }

    // --- Daily deals ---
    async function loadDailyDeals() {
      try {
        const url = withCacheBust(blobUrl("twelve_daily_deals.json"));
        const res = await fetch(url);

        if (!res.ok) {
          console.error("Failed to fetch daily deals:", res.status, res.statusText);
          dailyDeals.style.display = "none";
          return;
        }

        const data = await res.json();
        const deals = Array.isArray(data.deals) ? data.deals : [];

        dailyDealsGrid.innerHTML = "";

        if (!deals.length) {
          dailyDeals.style.display = "none";
          return;
        }

        deals.forEach(item => dailyDealsGrid.appendChild(createDealCard(item)));

        dailyDeals.style.display = "block";
        dailyDealCount();
      } catch (err) {
        console.error("Error loading daily deals:", err);
        dailyDeals.style.display = "none";
      }
    }

    async function dailyDealCount() {
      try {
        const url = withCacheBust(blobUrl("deals.json"));
        const res = await fetch(url);
        if (!res.ok) return;

        const data = await res.json();
        const totalDeals = data.totalDeals || 0;

        if (statusMessageEl && totalDeals > 0) {
          statusMessageEl.textContent = `There are ${totalDeals.toLocaleString()} deals today, let's find yours!`;
        }
      } catch (err) {
        console.error("Error loading total deals count:", err);
      }
    }

    loadDailyDeals();

    // --- Submit search ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let brandTyped = sanitizeInput(brandInput.value);
      brandTyped = resolveClosestBrand(brandTyped);
      brandInput.value = brandTyped;

      const modelTyped = sanitizeInput(modelInput.value);

      updateFetchReady();

      if (!brandTyped && !modelTyped) {
        statusMessageEl.textContent = "Please enter a brand and/or a model.";
        return;
      }

      currentSearch = { brand: brandTyped, model: modelTyped };
      const displayQuery = [brandTyped, modelTyped].filter(Boolean).join(" ");

      statusMessageEl.textContent = "Searching deals…";
      resultsEl.innerHTML = "";
      if (loadMoreWrap) loadMoreWrap.style.display = "none";
      dailyDeals.style.display = "none";
      if (filtersEl) filtersEl.style.display = "none";

      let data;
      try {
        const res = await fetch("/api/search?" + new URLSearchParams({ query: displayQuery }));
        data = await res.json();
      } catch (err) {
        console.error("Search error:", err);
        statusMessageEl.textContent = "Search failed. Please try again.";
        dailyDeals.style.display = "block";
        return;
      }

      const results = (data && data.results) ? data.results : [];
      lastSearchResults = results;

      selectedGender = "";
      selectedShoeType = "";
      if (genderChips) setActiveChip(genderChips, genderChips.querySelector('.chip[data-gender=""]'));
      if (typeChips) setActiveChip(typeChips, typeChips.querySelector('.chip[data-type=""]'));

      if (!results.length) {
        statusMessageEl.textContent = `No results found for ${displayQuery}.`;
        if (filtersEl) filtersEl.style.display = "none";
        if (loadMoreWrap) loadMoreWrap.style.display = "none";
        dailyDeals.style.display = "block";
        return;
      }

      const genderRow = genderChips ? genderChips.closest(".filter-row") : null;
      if (genderRow) genderRow.style.display = "flex";

      const typeRow = typeChips ? typeChips.closest(".filter-row") : null;

      const hasBrand = !!brandTyped.trim();
      const hasModel = !!modelTyped.trim();

      if (typeRow) {
        if (hasBrand && !hasModel) {
          typeRow.style.display = "flex";
          if (typeChips) setActiveChip(typeChips, typeChips.querySelector('.chip[data-type=""]'));
        } else {
          typeRow.style.display = "none";
          selectedShoeType = "";
        }
      }

      if (filtersEl) filtersEl.style.display = "flex";
      renderFilteredResults(true);
    });

    brandInput.addEventListener("input", updateFetchReady);
    modelInput.addEventListener("input", updateFetchReady);
  </script>
</body>
</html>
